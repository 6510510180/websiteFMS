<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | FMS Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --purple:       #6B3FA0;
  --purple-dark:  #4A2870;
  --purple-light: #F3EEFF;
  --purple-mid:   #E8DEFF;
  --accent:       #9B6DD1;
  --bg:           #F7F5FA;
  --white:        #FFFFFF;
  --text:         #181117;
  --text-sub:     #64748B;
  --border:       #EDE8F5;
  --red:          #EF4444;
  --red-bg:       #FEE2E2;
  --blue:         #3B82F6;
  --blue-bg:      #EFF6FF;
  --sidebar-w:    240px;
  --topbar-h:     64px;
  --radius:       12px;
  --shadow:       0 1px 3px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md:    0 4px 12px rgba(107,63,160,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Noto Sans Thai', 'Lexend', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  min-height: 100vh;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width: var(--sidebar-w);
  background: var(--white);
  height: 100vh;
  position: fixed;
  left: 0; top: 0;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  z-index: 100;
}
.sidebar-brand { padding: 20px 20px 16px; border-bottom: 1px solid var(--border); }
.sidebar-brand-title { font-family: 'Lexend', sans-serif; font-size: 16px; font-weight: 700; color: var(--text); }
.sidebar-brand-sub { font-size: 11.5px; color: var(--purple); font-weight: 500; margin-top: 2px; }
.sidebar-section-label { padding: 20px 20px 6px; font-size: 10px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1.2px; }
.sidebar-nav { flex: 1; padding: 8px 12px; display: flex; flex-direction: column; gap: 2px; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; font-size: 13.5px; font-weight: 500; color: var(--text-sub); text-decoration: none; transition: all 0.18s; cursor: pointer; }
.nav-item:hover { background: var(--purple-light); color: var(--purple); }
.nav-item.active { background: var(--purple-light); color: var(--purple); font-weight: 600; }
.nav-icon { width: 18px; height: 18px; flex-shrink: 0; opacity: 0.75; }
.nav-item.active .nav-icon, .nav-item:hover .nav-icon { opacity: 1; }
.sidebar-footer { padding: 12px; border-top: 1px solid var(--border); }
.sidebar-footer .nav-item { color: var(--red); }
.sidebar-footer .nav-item:hover { background: var(--red-bg); color: #DC2626; }

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar {
  position: fixed; top: 0; left: var(--sidebar-w); right: 0;
  height: var(--topbar-h); background: var(--white);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 32px; z-index: 90;
}
.topbar-left { display: flex; flex-direction: column; }
.topbar-title { font-family: 'Lexend', sans-serif; font-size: 16px; font-weight: 700; color: var(--text); }
.topbar-breadcrumb { font-size: 11.5px; color: var(--text-sub); margin-top: 1px; }
.topbar-breadcrumb a { color: var(--purple); text-decoration: none; cursor: pointer; }
.topbar-breadcrumb a:hover { text-decoration: underline; }
.topbar-right { display: flex; align-items: center; gap: 14px; }
.avatar-wrap { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 6px 10px; border-radius: 8px; transition: background 0.15s; }
.avatar-wrap:hover { background: var(--purple-light); }
.avatar-name { font-size: 13px; font-weight: 600; color: var(--purple); }
.avatar-circle { width: 34px; height: 34px; border-radius: 50%; background: var(--purple-mid); border: 2px solid var(--purple-light); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--purple); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main {
  margin-left: var(--sidebar-w);
  padding-top: var(--topbar-h);
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
}

.page-body {
  padding: 32px;
  display: flex;
  gap: 28px;
  flex: 1;
  min-height: 0;
}

/* ‚îÄ‚îÄ Left column: major info card ‚îÄ‚îÄ */
.col-left {
  width: 300px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.info-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  box-shadow: var(--shadow);
}

.info-major-name {
  font-family: 'Lexend', sans-serif;
  font-size: 20px;
  font-weight: 800;
  color: var(--text);
  line-height: 1.2;
  margin-bottom: 4px;
}

.info-major-en {
  font-size: 13px;
  color: var(--text-sub);
  margin-bottom: 14px;
}

.meta-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  background: var(--purple-light);
  color: var(--purple);
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 20px;
}

.info-divider { height: 1px; background: var(--border); margin: 16px 0; }

.info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 13px; }
.info-label { color: var(--text-sub); }
.info-value { font-weight: 600; color: var(--text); text-align: right; }

/* Year tabs inside left card */
.year-tabs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 4px;
}
.year-tab {
  padding: 9px 10px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--white);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  color: var(--text-sub);
  transition: all 0.15s;
  text-align: center;
}
.year-tab:hover { background: var(--purple-light); color: var(--purple); border-color: var(--purple); }
.year-tab.active { background: var(--purple); color: white; border-color: var(--purple); box-shadow: 0 3px 8px rgba(107,63,160,0.25); }

.back-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 11px 18px;
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  font-size: 13.5px;
  font-weight: 600;
  color: var(--text-sub);
  cursor: pointer;
  font-family: inherit;
  transition: all 0.15s;
  text-decoration: none;
  box-shadow: var(--shadow);
}
.back-btn:hover { border-color: var(--purple); color: var(--purple); background: var(--purple-light); }

/* ‚îÄ‚îÄ Right column: plan ‚îÄ‚îÄ */
.col-right {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.plan-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.plan-heading {
  font-family: 'Lexend', sans-serif;
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.plan-heading-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--purple); }

.btn-add-sem {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  background: var(--purple-light);
  color: var(--purple);
  border: 1.5px solid var(--purple-mid);
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.15s;
}
.btn-add-sem:hover { background: var(--purple); color: white; border-color: var(--purple); }

/* Semester card */
.semester-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  animation: fadeUp 0.3s ease both;
}
.semester-card:nth-child(2) { animation-delay: 0.05s; }
.semester-card:nth-child(3) { animation-delay: 0.10s; }
@keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

.semester-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
  transition: background 0.12s;
}
.semester-head:hover { background: var(--purple-light); }

.semester-head-left { display: flex; align-items: center; gap: 10px; }
.semester-name { font-family: 'Lexend', sans-serif; font-size: 15px; font-weight: 700; color: var(--text); }
.credits-badge {
  padding: 3px 10px;
  background: var(--purple-light);
  color: var(--purple);
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
}
.chevron { font-size: 11px; color: var(--text-sub); transition: transform 0.2s; }
.semester-card.collapsed .chevron { transform: rotate(-90deg); }
.semester-card.collapsed .semester-body { display: none; }

/* Subject rows */
.subject-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding: 13px 20px;
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}
.subject-row:hover { background: var(--purple-light); }

.subject-left { flex: 1; min-width: 0; }
.subject-code { font-size: 12px; font-weight: 700; color: var(--purple); margin-bottom: 2px; letter-spacing: 0.3px; }
.subject-name { font-size: 14px; font-weight: 600; color: var(--text); }
.subject-cat {
  display: inline-block;
  margin-top: 4px;
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 999px;
  background: var(--bg);
  color: var(--text-sub);
}
.subject-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.subject-credits { font-size: 14px; font-weight: 700; color: var(--text); white-space: nowrap; }
.subject-credits span { font-size: 11px; font-weight: 400; color: var(--text-sub); }
.del-btn {
  width: 28px; height: 28px;
  border-radius: 7px;
  background: none;
  border: 1px solid var(--border);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-sub);
  transition: all 0.12s;
}
.del-btn:hover { background: var(--red-bg); border-color: var(--red); color: var(--red); }

.empty-subjects {
  padding: 18px 20px;
  font-size: 13px;
  color: var(--text-sub);
  font-style: italic;
}

/* Add subject button row */
.add-subject-row {
  padding: 10px 16px;
  border-top: 1px dashed var(--border);
}
.add-subject-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 100%;
  padding: 10px;
  border: 1.5px dashed var(--border);
  border-radius: 8px;
  background: none;
  color: var(--text-sub);
  font-size: 13px;
  font-weight: 500;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.15s;
}
.add-subject-btn:hover { border-color: var(--purple); color: var(--purple); background: var(--purple-light); }

/* Empty / loading */
.empty-state { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); padding: 48px 20px; text-align: center; color: var(--text-sub); box-shadow: var(--shadow); }
.empty-icon { font-size: 36px; margin-bottom: 10px; }
.empty-state p { font-size: 14px; }
.loading-state { text-align: center; padding: 40px; color: var(--text-sub); font-size: 14px; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(15,10,40,0.5);
  backdrop-filter: blur(6px);
  z-index: 200;
  display: none; align-items: center; justify-content: center;
  padding: 20px;
}
.modal-overlay.open { display: flex; }

.modal {
  background: var(--white);
  border-radius: 20px;
  width: 100%;
  max-width: 820px;
  max-height: 92vh;
  overflow-y: auto;
  box-shadow: 0 32px 80px rgba(0,0,0,0.22);
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 24px 28px 18px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; background: white; z-index: 1;
  border-radius: 20px 20px 0 0;
}
.modal-title { font-family: 'Lexend', sans-serif; font-size: 18px; font-weight: 800; color: var(--text); }
.modal-title-sub { font-size: 13px; font-weight: 400; color: var(--text-sub); margin-top: 2px; }
.modal-close {
  width: 32px; height: 32px; border-radius: 8px;
  background: var(--bg); border: 1px solid var(--border);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 16px; color: var(--text-sub); transition: all 0.12s;
}
.modal-close:hover { background: var(--red-bg); color: var(--red); border-color: var(--red); }

.modal-body { padding: 24px 28px; display: flex; flex-direction: column; gap: 0; }

.section-label {
  font-size: 11px; font-weight: 700; color: var(--text-sub);
  text-transform: uppercase; letter-spacing: 1px;
  margin-bottom: 14px; margin-top: 22px;
  padding-bottom: 8px; border-bottom: 1px solid var(--border);
}
.section-label:first-child { margin-top: 0; }

.field { margin-bottom: 14px; }
.field label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }
.field input, .field select, .field textarea {
  width: 100%; padding: 11px 14px;
  border: 1.5px solid var(--border); border-radius: 10px;
  background: var(--bg); font-size: 14px; font-family: inherit; color: var(--text);
  outline: none; transition: all 0.15s;
}
.field input:focus, .field select:focus, .field textarea:focus {
  border-color: var(--purple); background: white;
  box-shadow: 0 0 0 3px rgba(107,63,160,0.1);
}
.field textarea { resize: vertical; min-height: 90px; line-height: 1.6; }
.field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.field-row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 14px; }

/* autofill hint */
.autofill-hint {
  display: none;
  font-size: 12px;
  color: var(--purple);
  font-weight: 600;
  margin-top: 6px;
  padding: 6px 12px;
  background: var(--purple-light);
  border-radius: 6px;
}

.modal-footer {
  padding: 16px 28px 24px;
  display: flex; gap: 10px; justify-content: flex-end;
  border-top: 1px solid var(--border);
  position: sticky; bottom: 0; background: white;
  border-radius: 0 0 20px 20px;
}
.btn-cancel { padding: 10px 22px; border-radius: 10px; background: var(--bg); border: 1.5px solid var(--border); font-size: 14px; font-family: inherit; cursor: pointer; color: var(--text); font-weight: 500; transition: background 0.12s; }
.btn-cancel:hover { background: var(--border); }
.btn-save { padding: 10px 26px; border-radius: 10px; background: var(--purple); color: white; border: none; font-size: 14px; font-weight: 700; font-family: inherit; cursor: pointer; transition: background 0.12s; box-shadow: 0 4px 12px rgba(107,63,160,0.3); }
.btn-save:hover { background: var(--purple-dark); }

/* Toast */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--text); color: white; padding: 12px 20px; border-radius: 12px; font-size: 14px; z-index: 999; transform: translateY(80px); opacity: 0; transition: all 0.3s; font-weight: 500; }
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: #16a34a; }
.toast.error { background: var(--red); }

svg { display: block; }
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-brand">
    <div class="sidebar-brand-title">FMS Admin</div>
    <div class="sidebar-brand-sub">PSU Faculty of Management</div>
  </div>
  <div class="sidebar-section-label">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</div>
  <nav class="sidebar-nav">
    <a class="nav-item" href="dashboard.html">
      <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/></svg>
      ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
    </a>
    <a class="nav-item active" href="study-plan.html">
      <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg>
      ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    </a>
    <a class="nav-item" href="course-list.html">
      <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762z"/></svg>
      ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
    </a>
    <a class="nav-item" href="qa-dashboard.html">
      <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
      ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    </a>
  </nav>
  <div class="sidebar-footer">
    <a class="nav-item" href="login.html" id="logoutBtn">
      <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/></svg>
      ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    </a>
  </div>
</aside>

<!-- TOPBAR -->
<header class="topbar">
  <div class="topbar-left">
    <div class="topbar-title" id="topbarTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div>
    <div class="topbar-breadcrumb">
      <a href="study-plan.html">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</a>
      <span id="breadcrumbSub"> ¬∑ <span id="breadcrumbMajor">-</span></span>
    </div>
  </div>
  <div class="topbar-right">
    <div class="avatar-wrap">
      <div class="avatar-name">Administrator</div>
      <div class="avatar-circle">A</div>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="main">
  <div class="page-body">

    <!-- Left: major info -->
    <div class="col-left">

      <a class="back-btn" href="study-plan.html">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
        ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </a>

      <div class="info-card">
        <div class="info-major-name" id="majorName">-</div>
        <div class="info-major-en" id="majorEn">-</div>
        <div class="meta-chip" id="majorCourse">
          <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z"/></svg>
          <span id="majorCourseName">-</span>
        </div>

        <div class="info-divider"></div>

        <div class="info-row">
          <span class="info-label">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
          <span class="info-value" id="infoYear">‡∏õ‡∏µ 1</span>
        </div>
        <div class="info-row">
          <span class="info-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
          <span class="info-value" id="infoSemCount">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏£‡∏ß‡∏°</span>
          <span class="info-value" id="infoTotalCredits">-</span>
        </div>
      </div>

      <div class="info-card">
        <div style="font-size:12px;font-weight:700;color:var(--text-sub);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</div>
        <div class="year-tabs" id="yearTabs">
          <button class="year-tab active" data-year="1" onclick="selectYear(1)">‡∏õ‡∏µ 1</button>
          <button class="year-tab" data-year="2" onclick="selectYear(2)">‡∏õ‡∏µ 2</button>
          <button class="year-tab" data-year="3" onclick="selectYear(3)">‡∏õ‡∏µ 3</button>
          <button class="year-tab" data-year="4" onclick="selectYear(4)">‡∏õ‡∏µ 4</button>
        </div>
      </div>

    </div>

    <!-- Right: semesters -->
    <div class="col-right">
      <div class="plan-topbar">
        <div class="plan-heading">
          <div class="plan-heading-dot"></div>
          <span id="planHeading">‡∏õ‡∏µ 1 ‚Äî Study Plan</span>
        </div>
        <button class="btn-add-sem" id="btnAddSemester">
          <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/></svg>
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>
      </div>

      <div id="semesterList">
        <div class="loading-state">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      </div>
    </div>

  </div>
</main>

<!-- Modal: Add Subject -->
<div class="modal-overlay" id="subjectModal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</div>
        <div class="modal-title-sub" id="modalSemName">-</div>
      </div>
      <button class="modal-close" id="modalClose">‚úï</button>
    </div>
    <div class="modal-body">

      <div class="section-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</div>
      <div class="field-row-3">
        <div class="field" style="grid-column:span 2">
          <label>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤ *</label>
          <input type="text" id="m_code" placeholder="‡πÄ‡∏ä‡πà‡∏ô 460-101" autocomplete="off" />
          <div class="autofill-hint" id="autofillHint">‚úì ‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Äî ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
        </div>
        <div class="field">
          <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï *</label>
          <input type="number" id="m_credits" placeholder="3" min="1" max="9" />
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) *</label>
          <input type="text" id="m_name_th" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢" />
        </div>
        <div class="field">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label>
          <input type="text" id="m_name_en" placeholder="Subject Name (EN)" />
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</label>
          <input type="text" id="m_hours" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3(3-0-6)" />
        </div>
        <div class="field">
          <label>‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤</label>
          <select id="m_category">
            <option value="Core">Core Course (‡∏ß‡∏¥‡∏ä‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</option>
            <option value="Elective">Elective (‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</option>
            <option value="GE">GE (‡∏ß‡∏¥‡∏ä‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
          </select>
        </div>
      </div>

      <div class="section-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</div>
      <div class="field-row">
        <div class="field">
          <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</label>
          <textarea id="m_desc_th" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢..."></textarea>
        </div>
        <div class="field">
          <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label>
          <textarea id="m_desc_en" placeholder="Course description in English..."></textarea>
        </div>
      </div>

      <div class="section-label">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</div>
      <div class="field-row">
        <div class="field">
          <label>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</label>
          <textarea id="m_out_th" placeholder="‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö..."></textarea>
        </div>
        <div class="field">
          <label>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label>
          <textarea id="m_out_en" placeholder="Learning outcomes after completing the course..."></textarea>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="modalCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-save" id="modalSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const BASE = "https://websitefms.onrender.com";
const API  = BASE + "/api";

if (!localStorage.getItem("user")) { window.location.href = "login.html"; }
document.getElementById("logoutBtn").addEventListener("click", e => {
  e.preventDefault(); localStorage.removeItem("user"); window.location.href = "login.html";
});

/* ‚îÄ‚îÄ URL params ‚îÄ‚îÄ */
const params   = new URLSearchParams(window.location.search);
const majorId  = params.get("majorId");
const courseId = params.get("courseId");
if (!majorId) { window.location.href = "study-plan.html"; }

let major = null;
let currentYear = 1;
let planId = null;
let planCache = {};
let modalSemId = null;
let modalSemName = "-";

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
function toast(msg, type = "") {
  const el = document.getElementById("toast");
  el.textContent = msg; el.className = "toast show " + type;
  setTimeout(() => el.className = "toast", 2800);
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
async function init() {
  try {
    // Load major info
    const majors = await fetch(`${API}/courses/${courseId}/majors`).then(r => r.json());
    major = majors.find(m => String(m.id) === String(majorId));
    if (!major) throw new Error("major not found");

    const courses = await fetch(`${API}/courses`).then(r => r.json());
    const course  = courses.find(c => String(c.id) === String(courseId));
    const courseName = course?.name_th || `Course #${courseId}`;

    document.getElementById("majorName").textContent     = major.name_th || "-";
    document.getElementById("majorEn").textContent       = major.name_en || "";
    document.getElementById("majorCourseName").textContent = courseName;
    document.getElementById("breadcrumbMajor").textContent = major.name_th || "-";
    document.getElementById("topbarTitle").textContent   = major.name_th || "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤";
    document.title = `${major.name_th} | FMS Admin`;

    await loadPlanForYear(1);
  } catch (e) {
    document.getElementById("semesterList").innerHTML =
      `<div class="empty-state"><div class="empty-icon">‚ùå</div><p>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p></div>`;
  }
}

/* ‚îÄ‚îÄ Year selection ‚îÄ‚îÄ */
function selectYear(year) {
  currentYear = year;
  document.querySelectorAll(".year-tab").forEach(b =>
    b.classList.toggle("active", Number(b.dataset.year) === year)
  );
  document.getElementById("planHeading").textContent = `‡∏õ‡∏µ ${year} ‚Äî Study Plan`;
  document.getElementById("infoYear").textContent = `‡∏õ‡∏µ ${year}`;
  loadPlanForYear(year);
}

/* ‚îÄ‚îÄ Load plan ‚îÄ‚îÄ */
async function loadPlanForYear(yearNo) {
  document.getElementById("semesterList").innerHTML = `<div class="loading-state">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
  planId = null;
  try {
    const plans = await fetch(`${API}/majors/${majorId}/study-plans?page=1&pageSize=20`).then(r => r.json());
    const yearData = plans.data || [];
    const thaiYear = new Date().getFullYear() + 543;
    let plan = yearData.find(p => Number(p.year_no) === yearNo);
    if (!plan) {
      const created = await fetch(`${API}/majors/${majorId}/study-plans`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ academic_year: thaiYear, year_no: yearNo, status: "active" })
      }).then(r => r.json());
      plan = created.plan;
    }
    if (!plan) throw new Error();
    planId = plan.id; planCache[yearNo] = planId;
    const detail = await fetch(`${API}/study-plans/${planId}`).then(r => r.json());
    renderSemesters(detail.semesters || [], yearNo);
  } catch {
    document.getElementById("semesterList").innerHTML =
      `<div class="empty-state"><div class="empty-icon">üì≠</div><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p></div>`;
  }
}

/* ‚îÄ‚îÄ Render semesters ‚îÄ‚îÄ */
function renderSemesters(semesters, yearNo) {
  // Update stats
  const totalCred = semesters.reduce((s, sem) =>
    s + (sem.subjects||[]).reduce((c, it) => c + Number(it.credits ?? it.default_credits ?? 0), 0), 0);
  document.getElementById("infoSemCount").textContent = `${semesters.length} ‡∏†‡∏≤‡∏Ñ`;
  document.getElementById("infoTotalCredits").textContent = `${totalCred} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï`;

  if (!semesters.length) {
    document.getElementById("semesterList").innerHTML =
      `<div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô ‡∏õ‡∏µ ${yearNo}<br>‡∏Å‡∏î "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
      </div>`;
    return;
  }

  document.getElementById("semesterList").innerHTML = semesters.map(sem => {
    const semCred = (sem.subjects||[]).reduce((s,it) => s + Number(it.credits ?? it.default_credits ?? 0), 0);
    const subjectsHtml = (sem.subjects||[]).map(it => {
      const catColor = { Core:"#6B3FA0", Elective:"#3B82F6", GE:"#10B981" }[it.category] || "#64748B";
      return `<div class="subject-row">
        <div class="subject-left">
          <div class="subject-code">${it.code}</div>
          <div class="subject-name">${it.name_th}</div>
          <span class="subject-cat" style="background:${catColor}18;color:${catColor}">${it.category||"Core"}</span>
        </div>
        <div class="subject-right">
          <div class="subject-credits">${it.credits ?? it.default_credits} <span>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</span></div>
          <button class="del-btn" onclick="deleteSubject(${it.id})" title="‡∏•‡∏ö">
            <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
          </button>
        </div>
      </div>`;
    }).join("");

    const emptySubs = !sem.subjects?.length
      ? `<div class="empty-subjects">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</div>`
      : "";

    return `<div class="semester-card" id="sem_${sem.id}">
      <div class="semester-head" onclick="toggleSem(${sem.id})">
        <div class="semester-head-left">
          <div class="semester-name">${sem.title || `Semester ${sem.term_no}`}</div>
          <span class="credits-badge">${semCred} Credits</span>
        </div>
        <span class="chevron">‚ñº</span>
      </div>
      <div class="semester-body">
        ${subjectsHtml}
        ${emptySubs}
        <div class="add-subject-row">
          <button class="add-subject-btn" onclick="openModal(${sem.id}, '${(sem.title||'').replace(/'/g,"\\'")}')">
            <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            Add Subject
          </button>
        </div>
      </div>
    </div>`;
  }).join("");
}

function toggleSem(id) { document.getElementById("sem_"+id)?.classList.toggle("collapsed"); }

/* ‚îÄ‚îÄ Add semester ‚îÄ‚îÄ */
document.getElementById("btnAddSemester").addEventListener("click", async () => {
  if (!planId) return toast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "error");
  try {
    const detail = await fetch(`${API}/study-plans/${planId}`).then(r => r.json());
    const existing = (detail.semesters||[]).map(s => Number(s.term_no));
    const next = [1,2,3].find(t => !existing.includes(t));
    if (!next) return toast("‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "error");
    const termNames = ["","‡∏õ‡∏µ "+currentYear+" - ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1","‡∏õ‡∏µ "+currentYear+" - ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 2","‡∏õ‡∏µ "+currentYear+" - ‡∏†‡∏≤‡∏Ñ‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô"];
    await fetch(`${API}/study-plans/${planId}/semesters`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ term_no: next, title: termNames[next], sort_order: next })
    });
    toast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì`, "success");
    const d = await fetch(`${API}/study-plans/${planId}`).then(r => r.json());
    renderSemesters(d.semesters||[], currentYear);
  } catch { toast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error"); }
});

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
function openModal(semId, semName) {
  modalSemId = semId; modalSemName = semName;
  ["m_code","m_name_th","m_name_en","m_credits","m_hours","m_desc_th","m_desc_en","m_out_th","m_out_en"]
    .forEach(id => document.getElementById(id).value = "");
  document.getElementById("autofillHint").style.display = "none";
  document.getElementById("modalSemName").textContent = semName;
  document.getElementById("subjectModal").classList.add("open");
}
function closeModal() { document.getElementById("subjectModal").classList.remove("open"); }
document.getElementById("modalCancel").addEventListener("click", closeModal);
document.getElementById("modalClose").addEventListener("click",  closeModal);
document.getElementById("subjectModal").addEventListener("click", e => {
  if (e.target === document.getElementById("subjectModal")) closeModal();
});

/* Auto-fill on code blur */
document.getElementById("m_code").addEventListener("blur", async () => {
  const code = document.getElementById("m_code").value.trim();
  if (!code) return;
  try {
    const items = await fetch(`${API}/subjects?query=${encodeURIComponent(code)}`).then(r => r.json());
    const found = items.find(it => it.code.toLowerCase() === code.toLowerCase());
    if (found) {
      document.getElementById("m_name_th").value = found.name_th || "";
      document.getElementById("m_name_en").value = found.name_en || "";
      document.getElementById("m_credits").value = found.default_credits || "";
      document.getElementById("m_hours").value   = found.default_hour_structure || "";
      document.getElementById("m_desc_th").value = found.description_th || "";
      document.getElementById("m_desc_en").value = found.description_en || "";
      document.getElementById("m_out_th").value  = found.outcomes_th || "";
      document.getElementById("m_out_en").value  = found.outcomes_en || "";
      document.getElementById("autofillHint").style.display = "block";
    }
  } catch {}
});

/* Save */
document.getElementById("modalSave").addEventListener("click", async () => {
  const code    = document.getElementById("m_code").value.trim();
  const name_th = document.getElementById("m_name_th").value.trim();
  const credits = Number(document.getElementById("m_credits").value);
  if (!code || !name_th || !credits) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï", "error");

  let subject_id = null;
  try {
    const items = await fetch(`${API}/subjects?query=${encodeURIComponent(code)}`).then(r => r.json());
    const found = items.find(it => it.code.toLowerCase() === code.toLowerCase());
    if (found) subject_id = found.id;
  } catch {}

  const payload = { category: document.getElementById("m_category").value, credits, hour_structure: document.getElementById("m_hours").value.trim() || null };
  if (subject_id) { payload.subject_id = subject_id; }
  else {
    Object.assign(payload, {
      code, name_th, default_credits: credits,
      name_en: document.getElementById("m_name_en").value.trim() || null,
      default_hour_structure: document.getElementById("m_hours").value.trim() || null,
      description_th: document.getElementById("m_desc_th").value.trim() || null,
      description_en: document.getElementById("m_desc_en").value.trim() || null,
      outcomes_th: document.getElementById("m_out_th").value.trim() || null,
      outcomes_en: document.getElementById("m_out_en").value.trim() || null,
    });
  }
  try {
    const res = await fetch(`${API}/semesters/${modalSemId}/subjects`, {
      method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error();
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì", "success");
    closeModal();
    const d = await fetch(`${API}/study-plans/${planId}`).then(r => r.json());
    renderSemesters(d.semesters||[], currentYear);
  } catch { toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error"); }
});

/* Delete */
async function deleteSubject(ssId) {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ?")) return;
  try {
    await fetch(`${API}/semester-subjects/${ssId}`, { method: "DELETE" });
    toast("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
    const d = await fetch(`${API}/study-plans/${planId}`).then(r => r.json());
    renderSemesters(d.semesters||[], currentYear);
  } catch { toast("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error"); }
}

init();
</script>
</body>
</html>