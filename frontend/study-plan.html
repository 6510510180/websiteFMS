<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | FMS Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#6C4DF6; --bg:#f7f6fb; --text:#222; --muted:#7a7a7a; --card:#fff; --border:#e8e6f1; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, "Noto Sans Thai", sans-serif; color: var(--text); background: var(--bg); display: flex; }

    /* ===== Sidebar ===== */
    .sidebar {
      width: 240px;
      background: white;
      height: 100vh;
      padding: 20px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
      position: fixed;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 { font-size: 20px; color: #5c2ea6; margin: 0 0 30px; }
    .menu { display: flex; flex-direction: column; gap: 4px; }
    .menu-item {
      padding: 12px; border-radius: 10px; cursor: pointer;
      color: #5e5e70; font-size: 14px; transition: 0.2s;
    }
    .menu-item:hover, .menu-item.active { background: #f1e6ff; color: #5c2ea6; }
    .sidebar-bottom { margin-top: auto; }

    /* ===== Main ===== */
    .main { margin-left: 240px; padding: 30px; width: calc(100% - 240px); }

    .panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 14px; }
    .grid { display: grid; gap: 12px; }
    .grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
    .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    label { font-size: 13px; color: #555; display: block; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%; border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 12px; background: #fff; font-family: inherit; font-size: 14px;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(108,77,246,0.12); }
    textarea { min-height: 90px; resize: vertical; }
    .btn { border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; background: #fff; cursor: pointer; font-family: inherit; font-size: 14px; }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn.primary:hover { background: #5a3dd8; }
    .row { display: flex; gap: 10px; align-items: center; }
    .muted { color: var(--muted); font-size: 13px; }
    .list { display: flex; flex-direction: column; gap: 10px; }
    .sem { border: 1px dashed var(--border); border-radius: 10px; padding: 10px; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .hidden { display: none; }
    .success { color: #0a7f43; } .error { color: #b00020; }
    h1 { margin: 0 0 20px; font-size: 22px; }
    h3 { margin: 14px 0 10px; }
  </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h2>FMS PSU</h2>
  <nav class="menu">
    <div class="menu-item" id="menuDashboard">üè† ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
    <div class="menu-item active" id="menuPlan">üìö ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div>
    <div class="menu-item" id="menuCourse">‚öôÔ∏è ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</div>
    <div class="menu-item" id="menuQA">üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div>
  </nav>
  <div class="sidebar-bottom">
    <div class="menu-item" id="logoutBtn">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
  </div>
</div>

<!-- Main -->
<div class="main">
  <h1>‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Admin)</h1>

  <section class="panel">
    <div class="grid cols-4">
      <div>
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>
        <select id="courseSelect"></select>
      </div>
      <div>
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤</label>
        <select id="majorSelect"></select>
      </div>
      <div>
        <label>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
        <input id="academicYear" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2026" />
      </div>
      <div>
        <label>‡∏õ‡∏µ‡∏ó‡∏µ‡πà</label>
        <select id="yearNo">
          <option value="1">‡∏õ‡∏µ 1</option>
          <option value="2">‡∏õ‡∏µ 2</option>
          <option value="3">‡∏õ‡∏µ 3</option>
          <option value="4">‡∏õ‡∏µ 4</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnOpenPlan">‡πÄ‡∏õ‡∏¥‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</button>
      <span class="muted" id="planInfo"></span>
    </div>
  </section>

  <section class="panel hidden" id="termPanel">
    <div class="header">
      <div class="row">
        <label style="margin:0">‡πÄ‡∏ó‡∏≠‡∏°</label>
        <select id="termNo">
          <option value="1">‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1</option>
          <option value="2">‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 2</option>
          <option value="3">‡∏†‡∏≤‡∏Ñ‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô</option>
        </select>
        <button class="btn" id="btnEnsureSemester">‡πÄ‡∏õ‡∏¥‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</button>
      </div>
      <div class="muted" id="semesterInfo"></div>
    </div>

    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°</h3>
    <div class="grid cols-3">
      <div><label>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label><input id="subCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 460-101" /></div>
      <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÑ‡∏ó‡∏¢)</label><input id="subNameTh" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢" /></div>
      <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label><input id="subNameEn" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©" /></div>
      <div><label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</label><input id="subCredits" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3" /></div>
      <div><label>‡πÇ‡∏Ñ‡∏£‡∏á‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡πÄ‡∏ä‡πà‡∏ô 3(3-0-6))</label><input id="subHours" /></div>
      <div><label>‡∏´‡∏°‡∏ß‡∏î</label><select id="subCategory"><option>Core</option><option>Elective</option><option>GE</option></select></div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div><label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÑ‡∏ó‡∏¢)</label><textarea id="subDescTh" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÑ‡∏ó‡∏¢)"></textarea></div>
      <div><label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label><textarea id="subDescEn" placeholder="Course Description (EN)"></textarea></div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div><label>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡πÑ‡∏ó‡∏¢)</label><textarea id="subOutTh" placeholder="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡πÑ‡∏ó‡∏¢)"></textarea></div>
      <div><label>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label><textarea id="subOutEn" placeholder="Learning Outcomes (EN)"></textarea></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnAddSubject">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</button>
      <span id="saveMsg" class="muted"></span>
    </div>

    <hr style="margin:16px 0"/>
    <h3>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</h3>
    <div id="subjectList" class="list"></div>
  </section>
</div>

<script>
  "use strict";

  // Auth
  const userData = localStorage.getItem("user");
  if (!userData) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô"); window.location.href = "login.html"; }

  // Sidebar navigation
  document.getElementById("menuDashboard").addEventListener("click", () => { window.location.href = "dashboard.html"; });
  document.getElementById("menuPlan").addEventListener("click", () => { window.location.href = "study-plan.html"; });
  document.getElementById("menuCourse").addEventListener("click", () => { window.location.href = "course-management.html"; });
  document.getElementById("menuQA").addEventListener("click", () => { window.location.href = "qa.html"; });
  document.getElementById("logoutBtn").addEventListener("click", () => { localStorage.removeItem("user"); window.location.href = "login.html"; });

  // API
  const BASE_URL = "https://websitefms.onrender.com";
  const api = {
    courses: `${BASE_URL}/api/courses`,
    majorsByCourse: id => `${BASE_URL}/api/courses/${id}/majors`,
    studyPlansMajor: id => `${BASE_URL}/api/majors/${id}/study-plans`,
    createPlanMajor: id => `${BASE_URL}/api/majors/${id}/study-plans`,
    plan: id => `${BASE_URL}/api/study-plans/${id}`,
    addSemester: id => `${BASE_URL}/api/study-plans/${id}/semesters`,
    addSubject: id => `${BASE_URL}/api/semesters/${id}/subjects`,
    searchSubjects: q => `${BASE_URL}/api/subjects?query=${encodeURIComponent(q)}`
  };

  const els = {
    courseSelect: document.getElementById("courseSelect"),
    majorSelect: document.getElementById("majorSelect"),
    academicYear: document.getElementById("academicYear"),
    yearNo: document.getElementById("yearNo"),
    btnOpenPlan: document.getElementById("btnOpenPlan"),
    planInfo: document.getElementById("planInfo"),
    termPanel: document.getElementById("termPanel"),
    termNo: document.getElementById("termNo"),
    btnEnsureSemester: document.getElementById("btnEnsureSemester"),
    semesterInfo: document.getElementById("semesterInfo"),
    subCode: document.getElementById("subCode"),
    subNameTh: document.getElementById("subNameTh"),
    subNameEn: document.getElementById("subNameEn"),
    subCredits: document.getElementById("subCredits"),
    subHours: document.getElementById("subHours"),
    subCategory: document.getElementById("subCategory"),
    subDescTh: document.getElementById("subDescTh"),
    subDescEn: document.getElementById("subDescEn"),
    subOutTh: document.getElementById("subOutTh"),
    subOutEn: document.getElementById("subOutEn"),
    btnAddSubject: document.getElementById("btnAddSubject"),
    saveMsg: document.getElementById("saveMsg"),
    subjectList: document.getElementById("subjectList")
  };

  const state = { planId: null, semesterId: null };

  async function getJSON(url, opts = {}) {
    const res = await fetch(url, opts);
    if (!res.ok) { let t = ""; try { t = await res.text(); } catch {} throw new Error(t || res.statusText); }
    return res.json();
  }
  function show(el) { el.classList.remove("hidden"); }
  function msg(el, text, type = "") { el.textContent = text; el.className = type || "muted"; setTimeout(() => { el.textContent = ""; el.className = "muted"; }, 2500); }

  (async function init() {
    els.courseSelect.addEventListener("change", loadMajors);
    els.btnOpenPlan.addEventListener("click", openOrCreatePlan);
    els.btnEnsureSemester.addEventListener("click", ensureSemester);
    els.btnAddSubject.addEventListener("click", addSubjectToSemester);
    els.subCode.addEventListener("blur", autocompleteSubject);
    await loadCourses();
    await loadMajors();
  })();

  async function loadCourses() {
    try {
      const data = await getJSON(api.courses);
      els.courseSelect.innerHTML = data.map(c => `<option value="${c.id}">${c.name_th || 'Course #' + c.id}</option>`).join("");
    } catch(e) { els.courseSelect.innerHTML = `<option>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`; }
  }

  async function loadMajors() {
    const courseId = els.courseSelect.value;
    if (!courseId) { els.majorSelect.innerHTML = ""; return; }
    try {
      const majors = await getJSON(api.majorsByCourse(courseId));
      els.majorSelect.innerHTML = majors.length
        ? majors.map(m => `<option value="${m.id}">${m.name_th || 'Major #' + m.id}</option>`).join("")
        : `<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤</option>`;
    } catch(e) { els.majorSelect.innerHTML = `<option>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`; }
  }

  async function autocompleteSubject() {
    const code = els.subCode.value.trim();
    if (!code) return;
    try {
      const items = await getJSON(api.searchSubjects(code));
      const found = items.find(it => it.code.toLowerCase() === code.toLowerCase());
      if (found) {
        els.subNameTh.value  = found.name_th || "";
        els.subNameEn.value  = found.name_en || "";
        els.subCredits.value = found.default_credits ?? "";
        els.subHours.value   = found.default_hour_structure || "";
        els.subDescTh.value  = found.description_th || "";
        els.subDescEn.value  = found.description_en || "";
        els.subOutTh.value   = found.outcomes_th || "";
        els.subOutEn.value   = found.outcomes_en || "";
        msg(els.saveMsg, "‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß", "success");
      }
    } catch(e) {}
  }

  async function openOrCreatePlan() {
    const majorId = Number(els.majorSelect.value);
    const academic_year = Number(els.academicYear.value);
    const year_no = Number(els.yearNo.value);
    if (!majorId || !academic_year || !year_no) return msg(els.planInfo, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "error");
    try {
      const list = await getJSON(`${api.studyPlansMajor(majorId)}?year_no=${year_no}&page=1&pageSize=50`);
      let found = (list.data || []).find(p => Number(p.academic_year) === academic_year && Number(p.year_no) === year_no);
      if (!found) {
        const created = await getJSON(api.createPlanMajor(majorId), {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ academic_year, year_no, status: "active" })
        });
        found = created.plan;
        msg(els.planInfo, "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì", "success");
      } else {
        msg(els.planInfo, "‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úì", "success");
      }
      state.planId = found.id;
      show(els.termPanel);
      els.semesterInfo.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏≠‡∏°";
      state.semesterId = null;
    } catch(e) { msg(els.planInfo, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message, "error"); }
  }

  async function ensureSemester() {
    if (!state.planId) return msg(els.semesterInfo, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡πà‡∏≠‡∏ô", "error");
    const term_no = Number(els.termNo.value);
    try {
      const detail = await getJSON(api.plan(state.planId));
      let sem = (detail.semesters || []).find(s => Number(s.term_no) === term_no);
      if (!sem) {
        const title = ["", "Semester 1", "Semester 2", "Summer"][term_no];
        await getJSON(api.addSemester(state.planId), {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ term_no, title, sort_order: term_no })
        });
        const d2 = await getJSON(api.plan(state.planId));
        sem = (d2.semesters || []).find(s => Number(s.term_no) === term_no);
        msg(els.semesterInfo, "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì", "success");
      } else {
        msg(els.semesterInfo, "‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úì", "success");
      }
      state.semesterId = sem.id;
      renderSemesterSubjects(sem);
    } catch(e) { msg(els.semesterInfo, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message, "error"); }
  }

  function renderSemesterSubjects(semester) {
    const subjects = semester.subjects || [];
    if (!subjects.length) {
      els.subjectList.innerHTML = `<div class="muted" style="padding:16px;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</div>`;
      return;
    }
    els.subjectList.innerHTML = subjects.map(it => {
      const credits = (it.credits != null) ? it.credits : it.default_credits;
      const hour = it.hour_structure || it.default_hour_structure || "";
      return `<div class="sem">
        <div class="row" style="justify-content:space-between">
          <div><b>${it.code}</b> ‚Äî ${it.name_th} <small class="muted">(${it.category})</small></div>
          <div><b>${credits}</b> ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</div>
        </div>
        ${hour ? `<div class="muted">${hour}</div>` : ""}
      </div>`;
    }).join("");
  }

  async function addSubjectToSemester() {
    if (!state.planId)     return msg(els.saveMsg, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡πà‡∏≠‡∏ô", "error");
    if (!state.semesterId) return msg(els.saveMsg, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô", "error");

    const code    = els.subCode.value.trim();
    const name_th = els.subNameTh.value.trim();
    const name_en = els.subNameEn.value.trim() || null;
    const credits = Number(els.subCredits.value || 0);
    const hour_structure = els.subHours.value.trim() || null;
    const category = els.subCategory.value;
    const description_th = els.subDescTh.value.trim() || null;
    const description_en = els.subDescEn.value.trim() || null;
    const outcomes_th = els.subOutTh.value.trim() || null;
    const outcomes_en = els.subOutEn.value.trim() || null;

    if (!code || !name_th || !credits) return msg(els.saveMsg, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï", "error");

    let subject_id = null;
    try {
      const items = await getJSON(api.searchSubjects(code));
      const found = items.find(it => it.code.toLowerCase() === code.toLowerCase());
      if (found) subject_id = found.id;
    } catch(e) {}

    const payload = { category, credits, hour_structure };
    if (subject_id) {
      payload.subject_id = subject_id;
    } else {
      Object.assign(payload, { code, name_th, name_en, default_credits: credits,
        default_hour_structure: hour_structure, description_th, description_en, outcomes_th, outcomes_en });
    }

    try {
      await getJSON(api.addSubject(state.semesterId), {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      msg(els.saveMsg, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì", "success");
      const detail = await getJSON(api.plan(state.planId));
      const sem = (detail.semesters || []).find(s => Number(s.term_no) === Number(els.termNo.value));
      if (sem) renderSemesterSubjects(sem);
      els.subNameTh.value = ""; els.subNameEn.value = "";
      els.subDescTh.value = ""; els.subDescEn.value = "";
      els.subOutTh.value  = ""; els.subOutEn.value  = "";
    } catch(e) { msg(els.saveMsg, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message, "error"); }
  }
</script>
</body>
</html>