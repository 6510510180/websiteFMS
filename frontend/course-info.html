<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ข้อมูลทั่วไปของหลักสูตร | FMS Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      background: #f8f8fb;
      font-family: "Segoe UI", sans-serif;
      display: flex;
    }
    .sidebar {
      width: 240px;
      background: white;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      padding: 20px;
      position: fixed;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 { font-size: 20px; margin-bottom: 30px; color: #5c2ea6; }
    .menu { margin-top: 10px; display: flex; flex-direction: column; }
    .menu-item {
      padding: 12px; border-radius: 10px; margin-bottom: 8px;
      cursor: pointer; color: #5e5e70; transition: 0.2s;
    }
    .menu-item.active, .menu-item:hover {
      background: #f1e6ff; color: #5c2ea6;
    }

    .main {
      margin-left: 260px;
      padding: 25px;
      width: calc(100% - 260px);
    }
    .page-header small { color:#999; font-size:13px; }
    .page-header h2 { margin:4px 0; }
    .page-header p { font-size:13px; color:#888; }

    .card {
      background:white;
      border-radius:16px;
      padding:20px 22px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      margin-bottom:20px;
    }
    .card-title { font-size:18px; font-weight:600; margin-bottom:6px; }

    .form-grid-2 {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:16px 24px;
      margin-top:12px;
      margin-bottom:16px;
    }
    .field label {
      display:block; font-size:13px; margin-bottom:4px; color:#555;
    }
    .field-value {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #eee;
      background:#f7f2ff;
      font-size:14px;
      color:#444;
    }

    .toggle-status {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      background:#e6ffe8;
      color:#1f8b3a;
      font-size:13px;
    }

    .image-row {
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      margin-top:10px;
    }
    .image-box {
      flex:1 1 260px;
    }
    .image-box img {
      max-width:100%;
      border-radius:16px;
      background:#eee;
    }

    .table-box { margin-top:10px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:10px; border-top:1px solid #eee; text-align:left; }
    th { color:#777; background:#faf7ff; }

    .status-pill {
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
    }
    .status-active { background:#dfffeb; color:#2e9a52; }
    .status-draft { background:#f8e1ff; color:#a600d9; }

    .btn-link {
      background: none;
      border: none;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      color: #5c2ea6;
    }
    .btn-link.danger { color:#c0392b; }
    .btn-link:hover { text-decoration: underline; }

    .header-actions {
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .btn-main {
      border-radius:999px;
      padding:6px 14px;
      border:none;
      cursor:pointer;
      font-size:13px;
      background:#8a3dd1;
      color:#fff;
      box-shadow:0 4px 10px rgba(138,61,209,0.25);
    }
    .btn-danger {
      border-radius:999px;
      padding:6px 14px;
      border:none;
      cursor:pointer;
      font-size:13px;
      background:#ffdddd;
      color:#b33939;
    }

    #message { margin-top:8px; font-size:13px; color:red; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>FMS PSU</h2>
    <div class="menu">
     <div class="menu-item active" id="menuDashboard">แดชบอร์ด</div>
      <div class="menu-item" id="menuPlan">แผนการศึกษา</div>
      <div class="menu-item" id="menuCourse">หลักสูตร</div>
      <div class="menu-item" id="menuQA">ประกันคุณภาพการศึกษา</div>
      <div class="menu-item" id="logoutBtn">ออกจากระบบ</div>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="page-header">
      <small>แดชบอร์ด / จัดการหลักสูตร / ข้อมูลทั่วไป</small>
      <h2>ข้อมูลทั่วไปของหลักสูตร</h2>
      <p>ตรวจสอบ แก้ไข และจัดการข้อมูลหลักสูตรที่บันทึกไว้ในระบบ</p>

      <div class="header-actions">
        <button id="editCourseBtn" class="btn-main">แก้ไขข้อมูลหลักสูตร</button>
        <button id="addMajorBtn"  class="btn-main">เพิ่มสาขาวิชาใหม่</button>
        <button id="deleteCourseBtn" class="btn-danger">ลบหลักสูตรนี้</button>
      </div>
    </div>

    <div id="message"></div>

    <!-- ข้อมูลหลักสูตร -->
    <div class="card">
      <div class="card-title">ข้อมูลหลักสูตร</div>
      <div class="form-grid-2">
        <div class="field">
          <label>ชื่อหลักสูตร (ภาษาไทย)</label>
          <div class="field-value" id="c_name_th">-</div>
        </div>
        <div class="field">
          <label>ระดับการศึกษา</label>
          <div class="field-value" id="c_degree_level">-</div>
        </div>
        <div class="field">
          <label>ชื่อหลักสูตร (ภาษาอังกฤษ)</label>
          <div class="field-value" id="c_name_en">-</div>
        </div>
        <div class="field">
          <label>ข้อมูลเพิ่มเติม</label>
          <div class="field-value" id="c_short_detail">-</div>
        </div>
        <div class="field">
          <label>สถานะหลักสูตร</label>
          <div id="c_status" class="toggle-status">
            <span>Active</span>
          </div>
        </div>
      </div>
      <div class="card">
  <div class="card-title">ภาพประกอบหลักสูตร</div>
  <img id="courseInfoImage"
       style="max-width:100%;border-radius:16px;display:none;">
</div>


      <!-- รูปภาพหลักสูตร -->
      <div class="image-row">
        <div class="image-box">
          <label style="font-size:13px;color:#666;">Hero Image (หน้า Portal / Bachelor Portal)</label>
          <img id="c_hero_image" src="" alt="hero image" style="display:none;">
        </div>
        <div class="image-box">
          <label style="font-size:13px;color:#666;">Info Image (หน้า Course Info + หน้า Public รายละเอียด)</label>
          <img id="c_info_image" src="" alt="info image" style="display:none;">
        </div>
      </div>
    </div>

    <!-- ข้อมูลโครงสร้างหลักสูตร -->
    <div class="card">
      <div class="card-title">รายละเอียดโครงสร้างหลักสูตร</div>
      <div class="form-grid-2">
        <div class="field">
          <label>รูปแบบหลักสูตร</label>
          <div class="field-value" id="c_program_type">-</div>
        </div>
        <div class="field">
          <label>การจัดการศึกษา</label>
          <div class="field-value" id="c_study_system">-</div>
        </div>
        <div class="field">
          <label>การให้ปริญญา</label>
          <div class="field-value" id="c_award_title">-</div>
        </div>
        <div class="field">
          <label>จำนวนหน่วยกิตตลอดหลักสูตร</label>
          <div class="field-value" id="c_total_credits">-</div>
        </div>
      </div>
    </div>

    <!-- ตารางสาขาวิชา -->
    <div class="card table-box">
      <div class="card-title">สาขาวิชาที่เปิดสอน</div>
      <table>
        <thead>
          <tr>
            <th>ชื่อสาขาวิชา</th>
            <th>คำอธิบาย</th>
            <th>สถานะ</th>
            <th>จัดการ</th>
          </tr>
        </thead>
        <tbody id="majorTable">
          <tr><td colspan="4">ยังไม่มีข้อมูลสาขาวิชา</td></tr>
        </tbody>
      </table>
    </div>
    

  </div>

  <script>
    const BASE_URL = "https://websitefms.onrender.com";
    const API_BASE = BASE_URL + "/api";


    // ตรวจ token
    const userData = localStorage.getItem("user");

if (!userData) {
  alert("กรุณาเข้าสู่ระบบก่อน");
  window.location.href = "login.html";
}
// เพิ่มต่อจาก logoutBtn
document.getElementById("addCourseBtn").addEventListener("click", () => {
  window.location.href = "add-course.html";
});

document.getElementById("menuDashboard")?.addEventListener("click", () => {
  window.location.href = "dashboard.html";
});

document.getElementById("menuPlan")?.addEventListener("click", () => {
  window.location.href = "study-plan.html";
});

document.getElementById("menuCourse")?.addEventListener("click", () => {
  window.location.href = "course-list.html";
});


const user = JSON.parse(userData);
const token = user.token;


    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    });

    const msg = document.getElementById("message");
    const params = new URLSearchParams(window.location.search);
    const courseId = params.get("courseId");

    if (!courseId) {
      msg.textContent = "ไม่พบรหัสหลักสูตร (courseId)";
    } else {
      loadCourse(courseId);
      loadMajors(courseId);
    }

    // ปุ่มแก้ไข / เพิ่มสาขา / ลบหลักสูตร
    const editBtn   = document.getElementById("editCourseBtn");
    const addMajorBtn = document.getElementById("addMajorBtn");
    const deleteBtn = document.getElementById("deleteCourseBtn");

    if (editBtn) {
      editBtn.addEventListener("click", () => {
        window.location.href = `add-course.html?courseId=${courseId}`;
      });
    }
    if (addMajorBtn) {
      addMajorBtn.addEventListener("click", () => {
        window.location.href = `add-major.html?courseId=${courseId}`;
      });
    }
    if (deleteBtn) {
  deleteBtn.addEventListener("click", async () => {
    if (!confirm("ต้องการลบหลักสูตรนี้พร้อมสาขาวิชาทั้งหมดใช่หรือไม่?")) return;

    try {
      const res = await fetch(`${API_BASE}/courses/${courseId}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.message || "ลบหลักสูตรไม่สำเร็จ");
        return;
      }

      alert("ลบหลักสูตรสำเร็จ");
      window.location.href = "dashboard.html";

    } catch (err) {
      console.error(err);
      alert("เชื่อมต่อเซิร์ฟเวอร์ไม่ได้ (ลบหลักสูตร)");
    }
  });
}


    // ---------- โหลดข้อมูลหลักสูตร ----------
    async function loadCourse(id) {
      try {
        const res = await fetch(`${API_BASE}/courses/${id}`);
        const course = await res.json();
        if (!res.ok) {
          msg.textContent = course.message || "ไม่สามารถดึงข้อมูลหลักสูตรได้";
          return;
        }

        document.getElementById("c_name_th").textContent       = course.name_th || "-";
        document.getElementById("c_degree_level").textContent  = course.degree_level || "-";
        document.getElementById("c_name_en").textContent       = course.name_en || "-";
        document.getElementById("c_short_detail").textContent  = course.short_detail || "-";
        document.getElementById("c_program_type").textContent  = course.program_type || "-";
        document.getElementById("c_study_system").textContent  = course.study_system || "-";
        document.getElementById("c_award_title").textContent   = course.award_title || "-";
        document.getElementById("c_total_credits").textContent = course.total_credits ?? "-";
        

        const statusEl = document.getElementById("c_status");
        if (course.status === "active") {
          statusEl.textContent = "พร้อมใช้งาน (Active)";
          statusEl.style.background = "#e6ffe8";
          statusEl.style.color = "#1f8b3a";
        } else if (course.status === "maintenance") {
          statusEl.textContent = "ปิดปรับปรุง (Maintenance)";
          statusEl.style.background = "#ffe8e6";
          statusEl.style.color = "#b33939";
        } else {
          statusEl.textContent = "ฉบับร่าง (Draft)";
          statusEl.style.background = "#f8e1ff";
          statusEl.style.color = "#a600d9";
        }

        // รูปภาพ
        const heroImg = document.getElementById("c_hero_image");
        const infoImg = document.getElementById("c_info_image");

        if (course.hero_image) {
          heroImg.src = BASE_URL + course.hero_image;
          heroImg.style.display = "block";
        } else {
          heroImg.style.display = "none";
        }

        if (course.info_image) {
          infoImg.src = BASE_URL + course.info_image;
          infoImg.style.display = "block";
        } else {
          infoImg.style.display = "none";
        }

      } catch (err) {
        console.error(err);
        msg.textContent = "เชื่อมต่อเซิร์ฟเวอร์ไม่ได้ (course)";
      }
    }

    // ---------- โหลดสาขาวิชา ----------
    async function loadMajors(id) {
      try {
        const res = await fetch(`${API_BASE}/courses/${id}/majors`);
        const majors = await res.json();
        const tbody = document.getElementById("majorTable");

        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="4">${majors.message || "ไม่สามารถดึงข้อมูลสาขาวิชาได้"}</td></tr>`;
          return;
        }

        if (!majors.length) {
          tbody.innerHTML = `<tr><td colspan="4">ยังไม่มีข้อมูลสาขาวิชา</td></tr>`;
          return;
        }

        tbody.innerHTML = "";
        majors.forEach(m => {
          const introShort = (m.intro || "").slice(0, 80);
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${m.name_th || "-"}</td>
            <td>${introShort || "-"}</td>
            <td><span class="status-pill status-active">ใช้งานได้</span></td>
            <td>
              <button class="btn-link edit-major" data-id="${m.id}">แก้ไข</button>
              <button class="btn-link danger delete-major" data-id="${m.id}">ลบ</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // event ปุ่มแก้ไข / ลบ
        document.querySelectorAll(".edit-major").forEach(btn => {
          btn.addEventListener("click", () => {
            const majorId = btn.dataset.id;
            window.location.href = `add-major.html?courseId=${courseId}&majorId=${majorId}`;
          });
        });

        document.querySelectorAll(".delete-major").forEach(btn => {
          btn.addEventListener("click", async () => {
            const majorId = btn.dataset.id;
            if (!confirm("ต้องการลบสาขาวิชานี้ใช่หรือไม่?")) return;
            try {
              const res = await fetch(`${API_BASE}/majors/${majorId}`, {
                method: "DELETE",});
              const data = await res.json();
              if (!res.ok) {
                alert(data.message || "ลบข้อมูลไม่สำเร็จ");
                return;
              }
              loadMajors(courseId); // โหลดใหม่
            } catch (err) {
              console.error(err);
              alert("เชื่อมต่อเซิร์ฟเวอร์ไม่ได้ (ลบสาขา)");
            }
          });
        });

      } catch (err) {
        console.error(err);
        document.getElementById("majorTable").innerHTML =
          `<tr><td colspan="4">เชื่อมต่อเซิร์ฟเวอร์ไม่ได้ (majors)</td></tr>`;
      }
    }
  </script>
</body>
</html>
