<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå PLO | FMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;900&family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --purple: #7F13EC;
  --purple-dark: #5c0db0;
  --purple-mid: #9B6DD1;
  --purple-light: #F3EEFF;
  --purple-bg: #EDE7F3;
  --text: #21111C;
  --text-sub: #64748B;
  --border: rgba(0,0,0,0.09);
  --white: #FFFFFF;
  --bg: #F7F4FC;
  --green: #22c55e;
  --amber: #f59e0b;
  --red: #ef4444;
  --teal: #0891b2;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Noto Sans Thai', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; font-size: 13px; }

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar {
  width: 100%; height: 64px; background: var(--white); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 40px; gap: 16px;
  position: sticky; top: 0; z-index: 200; box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.topbar-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
.logo-icon { width: 32px; height: 32px; background: var(--purple); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.logo-icon svg { width: 18px; height: 18px; fill: white; }
.topbar-brand { font-family: 'Lexend', sans-serif; font-size: 17px; font-weight: 700; color: var(--text); }
.topbar-nav { display: flex; align-items: center; gap: 4px; margin-left: 32px; flex: 1; }
.topbar-nav a {
  padding: 8px 16px; border-radius: 8px; font-family: 'Lexend', sans-serif;
  font-size: 14px; font-weight: 600; color: var(--text-sub); text-decoration: none; transition: .18s; white-space: nowrap;
}
.topbar-nav a:hover { background: var(--purple-light); color: var(--purple); }
.topbar-nav a.active { color: var(--purple); border-bottom: 2px solid var(--purple); border-radius: 0; padding-bottom: 6px; }
.topbar-right { margin-left: auto; }
.avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--purple-bg); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: var(--purple); cursor: pointer; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.page { display: flex; gap: 24px; padding: 32px 40px 80px; max-width: 100%; }
.main-col { flex: 1; min-width: 0; }
.side-col { width: 300px; flex-shrink: 0; }

/* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
.page-title { font-size: 20px; font-weight: 900; color: var(--text); line-height: 1.3; margin-bottom: 20px; }
.page-title span { color: var(--purple); }

/* ‚îÄ‚îÄ UNSAVED BADGE ‚îÄ‚îÄ */
.unsaved-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: #fff7ed; border: 1.5px solid #fed7aa; color: #c2410c;
  padding: 6px 14px; border-radius: 999px; font-size: 12px; font-weight: 700;
  margin-bottom: 16px; opacity: 0; transition: opacity .25s;
}
.unsaved-badge.show { opacity: 1; }
.unsaved-dot { width: 7px; height: 7px; border-radius: 50%; background: #f97316; animation: pulse 1.2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card {
  background: var(--white); border-radius: 14px;
  border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(127,19,236,0.06);
  overflow: hidden; margin-bottom: 16px;
}
.card-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px; border-bottom: 1px solid var(--border);
}
.card-title { font-size: 14px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }
.card-title svg { width: 16px; height: 16px; fill: var(--purple); }
.avg-badge {
  font-family: 'Lexend', sans-serif; font-size: 11px; font-weight: 700;
  background: var(--purple-bg); color: var(--purple);
  padding: 3px 10px; border-radius: 999px;
}

/* ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ */
.action-row { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.btn {
  display: flex; align-items: center; gap: 7px;
  padding: 9px 18px; border-radius: 10px;
  font-family: 'Noto Sans Thai', sans-serif; font-size: 13px; font-weight: 700;
  cursor: pointer; border: none; transition: .18s; white-space: nowrap;
}
.btn-primary { background: var(--purple); color: white; box-shadow: 0 4px 10px rgba(127,19,236,0.2); }
.btn-primary:hover { background: var(--purple-dark); transform: translateY(-1px); }
.btn-outline { background: white; color: var(--purple); border: 1.5px solid var(--purple); }
.btn-outline:hover { background: var(--purple-light); }
.btn-green { background: #16a34a; color: white; }
.btn-green:hover { background: #15803d; }
.btn svg { width: 15px; height: 15px; fill: currentColor; }
#fileInput { display: none; }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { background: #faf7ff; color: var(--text-sub); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; padding: 10px 14px; border-bottom: 2px solid #ede8f5; text-align: center; white-space: nowrap; }
th.left { text-align: left; }
td { padding: 10px 14px; border-bottom: 1px solid #f3eeff; vertical-align: middle; }
td.label-cell { font-size: 12.5px; color: var(--text); max-width: 280px; line-height: 1.4; }
td.label-cell .lo-code { font-family: 'Lexend', sans-serif; font-size: 11px; font-weight: 700; color: var(--purple); margin-bottom: 2px; }
td.label-cell .lo-desc { font-size: 11.5px; color: var(--text-sub); }
td.score-cell { text-align: center; }

/* ‚úÖ ‡πÅ‡∏Å‡πâ: input ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° ‡πÉ‡∏ä‡πâ type=text ‡πÅ‡∏ó‡∏ô number */
td.score-cell input {
  width: 72px; height: 36px;
  border: 1.5px solid #e0d8f0; border-radius: 8px;
  text-align: center;
  font-family: 'Lexend', sans-serif; font-size: 14px; font-weight: 700;
  color: var(--text); background: #faf8ff; outline: none; transition: .15s;
  /* ‚úÖ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ type=number ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô re-render ‡∏Ç‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° */
}
td.score-cell input:focus { border-color: var(--purple); box-shadow: 0 0 0 3px rgba(127,19,236,0.08); background: white; }
td.score-cell input.invalid { border-color: var(--red); background: #fff5f5; }
td.score-cell input:disabled { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
.score-avg { font-family: 'Lexend', sans-serif; font-size: 14px; font-weight: 800; }

/* section rows */
.section-row td { background: #f5eeff; font-size: 12px; font-weight: 700; color: var(--purple); padding: 8px 14px; border-bottom: 1px solid #e8deff; }
.total-row td { background: #2d1b4e; color: white; font-weight: 700; font-size: 13px; padding: 12px 14px; }
.total-row td .score-avg { color: #c4b5fd; }
.subtotal-row td { background: #6b21a8; color: white; font-weight: 700; padding: 10px 14px; }

/* ‚îÄ‚îÄ SIDE PANEL ‚îÄ‚îÄ */
.side-card {
  background: var(--white); border-radius: 14px;
  border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(127,19,236,0.06);
  padding: 18px; margin-bottom: 14px;
}
.side-card h3 { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 12px; display: flex; align-items: center; gap: 7px; }
.side-card h3 svg { width: 15px; height: 15px; }
.compare-item { margin-bottom: 10px; }
.compare-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
.compare-label span:first-child { color: var(--text-sub); }
.compare-label strong { font-family: 'Lexend', sans-serif; font-weight: 700; }
.bar-bg { height: 8px; background: #f0ebfa; border-radius: 999px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 999px; background: var(--purple); transition: width .5s ease; }
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
.stat-block { background: var(--purple-bg); border-radius: 10px; padding: 12px; text-align: center; }
.stat-block .stat-val { font-family: 'Lexend', sans-serif; font-size: 24px; font-weight: 800; color: var(--purple); }
.stat-block .stat-label { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
.summary-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
.summary-list li { display: flex; gap: 8px; align-items: flex-start; font-size: 12px; line-height: 1.5; color: var(--text-sub); }
.bullet { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
.bullet.green { background: var(--green); }
.bullet.amber { background: var(--amber); }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: 28px; right: 28px;
  background: #1a1a2e; color: white; padding: 12px 18px; border-radius: 12px;
  font-size: 13px; font-weight: 600; box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  display: flex; align-items: center; gap: 10px;
  transform: translateY(80px); opacity: 0;
  transition: all .3s cubic-bezier(.34,1.56,.64,1); z-index: 9999; pointer-events: none;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
</style>
</head>
<body>

<!-- TOPBAR -->
<header class="topbar">
  <a class="topbar-logo" href="#">
    <div class="logo-icon"><svg viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z"/></svg></div>
    <span class="topbar-brand">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</span>
  </a>
  <nav class="topbar-nav">
    <a href="qa-add.html">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <a href="plo.html">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ PLO/MLO</a>
    <a href="matrix.html">Alignment Matrix</a>
    <a href="score-plo.html" class="active">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå PLO</a>
    <a href="kas.html">KAS</a>
  </nav>
  <div class="topbar-right"><div class="avatar">A</div></div>
</header>

<!-- PAGE -->
<div class="page">

  <!-- MAIN COLUMN -->
  <div class="main-col">
    <div class="page-title">‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏ß‡∏ô‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤<br><span>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2567</span></div>

    <!-- Unsaved indicator -->
    <div class="unsaved-badge" id="unsavedBadge">
      <div class="unsaved-dot"></div>
      ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    </div>

    <div class="action-row">
      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
        <svg viewBox="0 0 20 20"><path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"/></svg>
        ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel
      </button>
      <button class="btn btn-outline" onclick="downloadTemplate()">
        <svg viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template
      </button>
      <button class="btn btn-green" onclick="exportExcel()">
        <svg viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"/></svg>
        Export Excel
      </button>
      <button class="btn btn-outline" onclick="addRowModal()">
        <svg viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
        ‡πÄ‡∏û‡∏¥‡πà‡∏° PLO/MLO
      </button>
    </div>
    <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="importExcel(event)">

    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <svg viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"/></svg>
          ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≤‡∏° PLO/MLO
        </div>
        <span class="avg-badge" id="avgBadge">Average Scale 1.0‚Äì5.0</span>
      </div>
      <div class="table-wrap">
        <table id="scoreTable">
          <thead>
            <tr>
              <th class="left" style="min-width:260px">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (Learning Outcomes)</th>
              <th style="width:90px">SEM 1</th>
              <th style="width:90px">SEM 2</th>
              <th style="width:100px">GRAND TOTAL</th>
              <th style="width:50px"></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SIDE COLUMN -->
  <div class="side-col">
    <div class="side-card">
      <h3>
        <svg viewBox="0 0 20 20" fill="var(--purple)"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zm6-4a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zm6-3a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/></svg>
        ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πâ‡∏≤‡∏ô
      </h3>
      <div id="compareSection"></div>
    </div>

    <div class="side-card">
      <h3>
        <svg viewBox="0 0 20 20" fill="var(--purple)"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
        ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
      </h3>
      <div class="stat-grid" id="statGrid"></div>
      <div style="margin-top:12px">
        <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="saveData()">
          <svg viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
      </div>
    </div>

    <div class="side-card">
      <h3>
        <svg viewBox="0 0 20 20" fill="var(--amber)"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
        ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞
      </h3>
      <ul class="summary-list" id="summaryList"></ul>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"><div class="toast-dot" id="toastDot"></div><span id="toastMsg"></span></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEY ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö localStorage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY = 'fms_plo_scores_2567';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEFAULT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_DATA = [
  { type:'section', label:'‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ (BA)' },
  { type:'row', code:'PLO1', desc:'‡∏Å‡∏≤‡∏£‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à', sem1:null, sem2:null },
  { type:'row', code:'PLO2', desc:'‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏¥‡∏ï‡∏™‡∏≥‡∏ô‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°', sem1:null, sem2:null },
  { type:'row', code:'PLO3', desc:'‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à', sem1:null, sem2:null },
  { type:'row', code:'PLO4', desc:'‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£', sem1:null, sem2:null },
  { type:'row', code:'PLO5', desc:'‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏° ‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏£‡∏£‡∏¢‡∏≤‡∏ö‡∏£‡∏£‡∏ì', sem1:null, sem2:null },
  { type:'row', code:'PLO6', desc:'‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï', sem1:null, sem2:null },
  { type:'row', code:'MLO', desc:'‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå', sem1:null, sem2:null },
  { type:'row', code:'MLO', desc:'‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ã‡πà‡∏≠‡∏∏‡∏õ‡∏ó‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå', sem1:null, sem2:null },
  { type:'row', code:'MLO', desc:'‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î', sem1:null, sem2:null },
  { type:'row', code:'MLO', desc:'‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à', sem1:null, sem2:null },
  { type:'row', code:'PLO', desc:'PLO', sem1:null, sem2:null },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏é‡∏¥‡∏ö‡∏±‡∏ï‡∏¥', desc:'', sem1:null, sem2:null },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°-‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°', desc:'', sem1:null, sem2:null },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì', desc:'‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®', sem1:null, sem2:null },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', desc:'‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏£‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', sem1:null, sem2:null },
  { type:'subtotal', label:'‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (Total)', refRows:'ba' },
  { type:'section', label:'‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ (Multi-disciplinary)' },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ', desc:'', sem1:null, sem2:null },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏é‡∏¥‡∏ö‡∏±‡∏ï‡∏¥', desc:'', sem1:null, sem2:null },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°-‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°', desc:'', sem1:null, sem2:null },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì', desc:'‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®', sem1:null, sem2:null },
  { type:'row', code:'‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', desc:'', sem1:null, sem2:null },
  { type:'subtotal', label:'‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ Total', refRows:'multi' },
  { type:'total', label:'‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à Total', refRows:'all_ba' },
  { type:'grand', label:'Grand Total', refRows:'all' },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD ‡∏à‡∏≤‡∏Å localStorage (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ DEFAULT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tableData;
try {
  const saved = localStorage.getItem(STORAGE_KEY);
  tableData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_DATA));
} catch {
  tableData = JSON.parse(JSON.stringify(DEFAULT_DATA));
}

let hasUnsaved = false;

function markUnsaved() {
  hasUnsaved = true;
  document.getElementById('unsavedBadge').classList.add('show');
}
function markSaved() {
  hasUnsaved = false;
  document.getElementById('unsavedBadge').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseScore(v) {
  if (v === null || v === undefined || String(v).trim() === '') return null;
  // ‡∏£‡∏±‡∏ö comma ‡πÄ‡∏õ‡πá‡∏ô dot ‡∏î‡πâ‡∏ß‡∏¢
  const n = parseFloat(String(v).replace(',', '.'));
  return isNaN(n) ? null : n;
}

function avg(vals) {
  const v = vals.filter(x => x !== null && x !== undefined);
  if (!v.length) return null;
  return v.reduce((a, b) => a + b, 0) / v.length;
}

function fmt(v) {
  if (v === null || v === undefined) return '<span style="color:#ccc">‚Äî</span>';
  const color = v >= 4.5 ? 'var(--green)' : v >= 4.0 ? 'var(--amber)' : 'var(--red)';
  return `<span class="score-avg" style="color:${color}">${v.toFixed(2)}</span>`;
}

function scoreColor(n) {
  if (n === null) return 'var(--purple)';
  return n >= 4.5 ? 'var(--green)' : n >= 4.0 ? 'var(--amber)' : 'var(--red)';
}

function getRowGrand(row) {
  return avg([row.sem1, row.sem2].filter(x => x !== null));
}

function computeGrand(refRows) {
  let rows;
  const multiSectionIdx = tableData.findIndex(t => t.type === 'section' && t.label.includes('Multi'));
  if (refRows === 'ba') {
    rows = tableData.filter((r, i) => r.type === 'row' && i < multiSectionIdx);
  } else if (refRows === 'multi') {
    rows = tableData.filter((r, i) => r.type === 'row' && i > multiSectionIdx);
  } else {
    rows = tableData.filter(r => r.type === 'row');
  }
  const s1 = avg(rows.map(r => r.sem1).filter(x => x !== null));
  const s2 = avg(rows.map(r => r.sem2).filter(x => x !== null));
  const gt = avg([s1, s2].filter(x => x !== null));
  return { sem1: s1, sem2: s2, grand: gt };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER TABLE (‡∏™‡∏£‡πâ‡∏≤‡∏á DOM ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable() {
  const tbody = document.getElementById('tableBody');
  let html = '';

  tableData.forEach((item, idx) => {
    if (item.type === 'section') {
      html += `<tr class="section-row"><td colspan="5">${item.label}</td></tr>`;
    } else if (item.type === 'row') {
      const grand = getRowGrand(item);
      html += `<tr>
        <td class="label-cell">
          ${item.code ? `<div class="lo-code">${item.code}</div>` : ''}
          ${item.desc ? `<div class="lo-desc">${item.desc}</div>` : ''}
        </td>
        <td class="score-cell">
          <input type="text" inputmode="decimal"
            value="${item.sem1 !== null ? item.sem1 : ''}"
            placeholder="‚Äî"
            data-idx="${idx}" data-sem="1"
            onblur="onScoreBlur(this)"
            oninput="onScoreTyping(this)">
        </td>
        <td class="score-cell">
          <input type="text" inputmode="decimal"
            value="${item.sem2 !== null ? item.sem2 : ''}"
            placeholder="‚Äî"
            data-idx="${idx}" data-sem="2"
            onblur="onScoreBlur(this)"
            oninput="onScoreTyping(this)">
        </td>
        <td class="score-cell" id="grand-${idx}">${fmt(grand)}</td>
        <td style="text-align:center">
          <button onclick="deleteRow(${idx})" title="‡∏•‡∏ö"
            style="border:none;background:none;cursor:pointer;color:#ccc;font-size:16px;padding:4px 6px;border-radius:6px;transition:.15s"
            onmouseover="this.style.color='#ef4444';this.style.background='#fee2e2'"
            onmouseout="this.style.color='#ccc';this.style.background='none'">üóë</button>
        </td>
      </tr>`;
    } else if (item.type === 'subtotal') {
      const c = computeGrand(item.refRows);
      html += `<tr class="subtotal-row">
        <td>${item.label}</td>
        <td style="text-align:center" id="sub1-${idx}">${fmt(c.sem1)}</td>
        <td style="text-align:center" id="sub2-${idx}">${fmt(c.sem2)}</td>
        <td style="text-align:center" id="subg-${idx}">${fmt(c.grand)}</td>
        <td></td>
      </tr>`;
    } else if (item.type === 'total' || item.type === 'grand') {
      const c = computeGrand(item.refRows);
      html += `<tr class="total-row">
        <td>${item.label}</td>
        <td style="text-align:center" id="tot1-${idx}">${fmt(c.sem1)}</td>
        <td style="text-align:center" id="tot2-${idx}">${fmt(c.sem2)}</td>
        <td style="text-align:center" id="totg-${idx}">${fmt(c.grand)}</td>
        <td></td>
      </tr>`;
    }
  });

  tbody.innerHTML = html;
  updateSidePanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT HANDLERS
//  ‚úÖ onScoreTyping = ‡πÅ‡∏Ñ‡πà validate ‡∏™‡∏µ ‡πÑ‡∏°‡πà re-render
//  ‚úÖ onScoreBlur   = ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤ + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ cell ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onScoreTyping(el) {
  const raw = el.value.replace(',', '.');
  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏à‡∏ö ‡πÄ‡∏ä‡πà‡∏ô "4." ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô
  if (raw === '' || raw === '-' || raw.endsWith('.')) {
    el.classList.remove('invalid');
    return;
  }
  const n = parseFloat(raw);
  if (isNaN(n) || n < 0 || n > 5) {
    el.classList.add('invalid');
  } else {
    el.classList.remove('invalid');
  }
}

function onScoreBlur(el) {
  const idx = parseInt(el.dataset.idx);
  const sem = el.dataset.sem;
  const raw = el.value.replace(',', '.');
  const n = raw === '' ? null : parseFloat(raw);

  // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà valid ‡πÉ‡∏´‡πâ clear
  if (n !== null && (isNaN(n) || n < 0 || n > 5)) {
    el.value = '';
    el.classList.remove('invalid');
    if (sem === '1') tableData[idx].sem1 = null;
    else tableData[idx].sem2 = null;
  } else {
    if (sem === '1') tableData[idx].sem1 = n;
    else tableData[idx].sem2 = n;
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
    if (n !== null) el.value = n;
    el.classList.remove('invalid');
  }

  markUnsaved();

  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ grand total ‡∏Ç‡∏≠‡∏á row ‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà re-render ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤)
  const grandCell = document.getElementById(`grand-${idx}`);
  if (grandCell) grandCell.innerHTML = fmt(getRowGrand(tableData[idx]));

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï subtotal / total / grand rows
  updateComputedRows();
  updateSidePanel();
}

function updateComputedRows() {
  tableData.forEach((item, idx) => {
    if (item.type === 'subtotal') {
      const c = computeGrand(item.refRows);
      const e1 = document.getElementById(`sub1-${idx}`);
      const e2 = document.getElementById(`sub2-${idx}`);
      const eg = document.getElementById(`subg-${idx}`);
      if (e1) e1.innerHTML = fmt(c.sem1);
      if (e2) e2.innerHTML = fmt(c.sem2);
      if (eg) eg.innerHTML = fmt(c.grand);
    } else if (item.type === 'total' || item.type === 'grand') {
      const c = computeGrand(item.refRows);
      const e1 = document.getElementById(`tot1-${idx}`);
      const e2 = document.getElementById(`tot2-${idx}`);
      const eg = document.getElementById(`totg-${idx}`);
      if (e1) e1.innerHTML = fmt(c.sem1);
      if (e2) e2.innerHTML = fmt(c.sem2);
      if (eg) eg.innerHTML = fmt(c.grand);
    }
  });
}

function deleteRow(idx) {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  tableData.splice(idx, 1);
  markUnsaved();
  renderTable();
}

function addRowModal() {
  const code = prompt('‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠ PLO-MLO (‡πÄ‡∏ä‡πà‡∏ô PLO7):');
  if (!code) return;
  const desc = prompt('‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:') || '';
  // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô subtotal ‡πÅ‡∏£‡∏Å
  const insertIdx = tableData.findIndex(r => r.type === 'subtotal' || r.type === 'total' || r.type === 'grand');
  tableData.splice(insertIdx > 0 ? insertIdx - 1 : tableData.length, 0,
    { type: 'row', code, desc, sem1: null, sem2: null }
  );
  markUnsaved();
  renderTable();
  showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDE PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSidePanel() {
  const rows = tableData.filter(r => r.type === 'row');
  const allGrands = rows.map(r => getRowGrand(r)).filter(v => v !== null);
  const overallAvg = avg(allGrands);

  const multiSectionIdx = tableData.findIndex(t => t.type === 'section' && t.label.includes('Multi'));
  const baRows = tableData.filter((r, i) => r.type === 'row' && i < multiSectionIdx);
  const baAvg = avg(baRows.map(r => getRowGrand(r)).filter(v => v !== null));

  const compareData = [
    { label: 'Grand Total', val: overallAvg, color: 'var(--purple)' },
    { label: '‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à', val: baAvg, color: 'var(--teal)' },
  ];

  document.getElementById('compareSection').innerHTML = compareData.map(c => `
    <div class="compare-item">
      <div class="compare-label">
        <span>${c.label}</span>
        <strong style="color:${c.color}">${c.val !== null ? c.val.toFixed(2) + ' / 5.0' : '‚Äî'}</strong>
      </div>
      <div class="bar-bg"><div class="bar-fill" style="width:${c.val ? ((c.val / 5) * 100).toFixed(1) : 0}%;background:${c.color}"></div></div>
    </div>
  `).join('');

  const pct = overallAvg ? Math.round((overallAvg / 5) * 100) : 0;
  document.getElementById('statGrid').innerHTML = `
    <div class="stat-block">
      <div class="stat-val" style="color:${scoreColor(overallAvg)}">${pct}%</div>
      <div class="stat-label">TARGET ACHIEVED</div>
    </div>
    <div class="stat-block">
      <div class="stat-val" style="color:${scoreColor(overallAvg)}">${overallAvg !== null ? overallAvg.toFixed(2) : '‚Äî'}</div>
      <div class="stat-label">OVERALL AVG</div>
    </div>
  `;

  const low = rows.filter(r => { const g = getRowGrand(r); return g !== null && g < 4.33; });
  let bullets = `<li><span class="bullet green"></span>‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡πà‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡∏Å‡∏£‡∏≠‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô AUN-QA ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (5.0)</li>`;
  if (low.length > 0) {
    bullets += `<li><span class="bullet amber"></span>PLO/MLO ‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (${low.map(r => r.code).join(', ')}) ‡∏Ñ‡∏ß‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</li>`;
  } else if (allGrands.length > 0) {
    bullets += `<li><span class="bullet green"></span>‡∏ó‡∏∏‡∏Å PLO/MLO ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>`;
  }
  document.getElementById('summaryList').innerHTML = bullets;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ‚úÖ SAVE ‚Üí localStorage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveData() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tableData));
    markSaved();
    showToast('‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '#22c55e');
  } catch (e) {
    showToast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '#ef4444');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function importExcel(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const wb = XLSX.read(ev.target.result, { type: 'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
      let imported = 0;
      const insertIdx = tableData.findIndex(r => r.type === 'subtotal' || r.type === 'total' || r.type === 'grand');
      for (let i = 1; i < json.length; i++) {
        const row = json[i];
        const code = String(row[0] || '').trim();
        const desc = String(row[1] || '').trim();
        const sem1 = parseScore(row[2]);
        const sem2 = parseScore(row[3]);
        if (!code && !desc) continue;
        tableData.splice((insertIdx > 0 ? insertIdx : tableData.length) + imported, 0, { type: 'row', code, desc, sem1, sem2 });
        imported++;
      }
      if (!imported) { showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', '#f59e0b'); return; }
      markUnsaved();
      renderTable();
      showToast(`‚úì ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${imported} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    } catch { showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', '#ef4444'); }
  };
  reader.readAsBinaryString(file);
  e.target.value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TEMPLATE & EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadTemplate() {
  const header = ['‡∏£‡∏´‡∏±‡∏™ (Code)', '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Description)', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô SEM 1', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô SEM 2'];
  const examples = [
    ['PLO1', '‡∏Å‡∏≤‡∏£‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à', 4.60, 4.54],
    ['PLO2', '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏¥‡∏ï‡∏™‡∏≥‡∏ô‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö', 4.57, 4.59],
    ['MLO1.1', '‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå', '', 4.66],
  ];
  const ws = XLSX.utils.aoa_to_sheet([header, ...examples]);
  ws['!cols'] = [{ wch: 14 }, { wch: 50 }, { wch: 14 }, { wch: 14 }];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'PLO Score Template');
  XLSX.writeFile(wb, 'plo_score_template.xlsx');
  showToast('‚úì ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

function exportExcel() {
  const header = ['‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠', '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢', 'SEM 1', 'SEM 2', 'Grand Total'];
  const dataRows = [];
  tableData.forEach(item => {
    if (item.type === 'section') {
      dataRows.push([item.label, '', '', '', '']);
    } else if (item.type === 'row') {
      const g = getRowGrand(item);
      dataRows.push([item.code, item.desc, item.sem1 ?? '', item.sem2 ?? '', g !== null ? parseFloat(g.toFixed(2)) : '']);
    } else if (item.type === 'subtotal' || item.type === 'total' || item.type === 'grand') {
      const c = computeGrand(item.refRows);
      dataRows.push([item.label, '', c.sem1 ? parseFloat(c.sem1.toFixed(2)) : '', c.sem2 ? parseFloat(c.sem2.toFixed(2)) : '', c.grand ? parseFloat(c.grand.toFixed(2)) : '']);
    }
  });
  const ws = XLSX.utils.aoa_to_sheet([header, ...dataRows]);
  ws['!cols'] = [{ wch: 30 }, { wch: 50 }, { wch: 12 }, { wch: 12 }, { wch: 14 }];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'PLO Score Report');
  XLSX.writeFile(wb, 'plo_score_report_2567.xlsx');
  showToast('‚úì Export Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg, color = '#22c55e') {
  const t = document.getElementById('toast');
  document.getElementById('toastDot').style.background = color;
  document.getElementById('toastMsg').textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderTable();
</script>
</body>
</html>