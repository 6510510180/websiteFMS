<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Add / Edit Course | FMS Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    /* ── SIDEBAR (QA-Dashboard style) ── */
    :root {
      --purple:#6B3FA0;--purple-dark:#4A2870;--purple-light:#F3EEFF;--purple-mid:#E8DEFF;
      --accent:#9B6DD1;--bg-base:#F7F5FA;--white:#FFFFFF;--text-main:#181117;--text-sub:#64748B;
      --border-col:#EDE8F5;--red:#EF4444;--red-bg:#FEE2E2;--sidebar-w:240px;--topbar-h:64px;
    }
    .sidebar-qa {
      width:var(--sidebar-w);background:var(--white);height:100vh;position:fixed;
      left:0;top:0;display:flex;flex-direction:column;border-right:1px solid var(--border-col);z-index:100;
    }
    .sidebar-brand{padding:20px 20px 16px;border-bottom:1px solid var(--border-col);}
    .sidebar-brand-title{font-family:'Lexend',sans-serif;font-size:16px;font-weight:700;color:var(--text-main);letter-spacing:-0.2px;}
    .sidebar-brand-sub{font-size:11.5px;color:var(--purple);font-weight:500;margin-top:2px;}
    .sidebar-section-label{padding:20px 20px 6px;font-size:10px;font-weight:700;color:var(--text-sub);text-transform:uppercase;letter-spacing:1.2px;}
    .sidebar-nav-qa{flex:1;padding:8px 12px;display:flex;flex-direction:column;gap:2px;overflow-y:auto;}
    .nav-item-qa{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:8px;
      font-size:13.5px;font-weight:500;color:var(--text-sub);
      text-decoration:none;transition:all 0.18s;cursor:pointer;user-select:none;
    }
    .nav-item-qa:hover{background:var(--purple-light);color:var(--purple);}
    .nav-item-qa.active{background:var(--purple-light);color:var(--purple);font-weight:600;}
    .nav-icon-qa{width:18px;height:18px;flex-shrink:0;opacity:0.75;}
    .nav-item-qa.active .nav-icon-qa,.nav-item-qa:hover .nav-icon-qa{opacity:1;}
    .sidebar-footer-qa{padding:12px;border-top:1px solid var(--border-col);}
    .sidebar-footer-qa .nav-item-qa{color:var(--red);}
    .sidebar-footer-qa .nav-item-qa:hover{background:var(--red-bg);color:#DC2626;}
    svg{display:block;}


:root {
  --primary: #7c3aed;
  --primary-light: #ede9fe;
  --sidebar-w: 230px;
  --text: #1e1b2e;
  --muted: #6b7280;
  --border: #e5e7eb;
  --bg: #f5f4fa;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Noto Sans Thai', 'Segoe UI', sans-serif;
  background: var(--bg);
  display: flex;
  min-height: 100vh;
}

/* ── SIDEBAR ── */
.sidebar {
  width: var(--sidebar-w);
  background: #fff;
  height: 100vh;
  position: fixed;
  left: 0; top: 0;
  display: flex;
  flex-direction: column;
  box-shadow: 2px 0 16px rgba(0,0,0,0.07);
  border-radius: 0 20px 20px 0;
  z-index: 100;
  overflow: hidden;
}
.sidebar-logo {
  padding: 22px 24px 18px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-logo .brand {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
  letter-spacing: -0.5px;
}
.sidebar-logo .brand-sub {
  font-size: 11px;
  color: var(--muted);
  margin-top: 1px;
}
.sidebar-nav {
  flex: 1;
  padding: 16px 14px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  overflow-y: auto;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  text-decoration: none;
  transition: background .18s, color .18s, transform .18s;
  user-select: none;
}
.nav-item:hover {
  background: var(--primary-light);
  color: var(--primary);
  transform: translateX(3px);
}
.nav-item.active {
  background: var(--primary-light);
  color: var(--primary);
  font-weight: 600;
}
.nav-item .nav-icon {
  font-size: 16px;
  width: 20px;
  text-align: center;
  flex-shrink: 0;
}
.sidebar-footer {
  padding: 14px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-footer .nav-item { color: #ef4444; }
.sidebar-footer .nav-item:hover {
  background: #fee2e2;
  color: #dc2626;
  transform: translateX(3px);
}

/* ── MAIN ── */
.main {
  margin-left: var(--sidebar-w);
  flex: 1;
  padding: 32px;
  display: flex;
  flex-direction: column;
  min-width: 0;
}
.page-header small { color: #999; font-size: 13px; }
.page-header h2 { margin: 4px 0; font-size: 22px; color: var(--text); }
.page-header p { font-size: 13px; color: var(--muted); }

.card {
  background: white;
  border-radius: 16px;
  padding: 20px 22px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}
.card-title { font-size: 18px; font-weight: 600; margin-bottom: 6px; }

.form-grid-2 {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 16px 24px;
  margin-top: 12px;
  margin-bottom: 16px;
}
.field { margin-bottom: 12px; }
.field label { display: block; font-size: 13px; margin-bottom: 4px; color: #555; }
.field input, .field textarea, .field select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid #ddd;
  background: #faf7ff;
  outline: none;
  font-size: 14px;
  font-family: inherit;
}
.field input:focus, .field textarea:focus, .field select:focus {
  border-color: var(--primary);
  background: #fff;
  box-shadow: 0 0 0 2px rgba(124,58,237,0.15);
}
textarea { resize: vertical; min-height: 80px; }

.footer-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 16px;
  flex-wrap: wrap;
}
.btn { border-radius: 999px; padding: 9px 22px; border: none; cursor: pointer; font-size: 14px; font-family: inherit; font-weight: 500; transition: opacity .15s; }
.btn:hover { opacity: 0.88; }
.btn-secondary { background: #ffdddd; color: #b33939; }
.btn-primary { background: var(--primary); color: white; box-shadow: 0 5px 14px rgba(124,58,237,0.3); }
.btn-success { background: #2ecc71; color: #fff; box-shadow: 0 5px 14px rgba(46,204,113,0.3); }
#message { margin-top: 8px; font-size: 13px; }
</style>
</head>
<body>
<aside class="sidebar-qa">
  <div class="sidebar-brand">
    <div class="sidebar-brand-title">FMS Admin</div>
    <div class="sidebar-brand-sub">PSU Faculty of Management</div>
  </div>
  <div class="sidebar-section-label">เมนูหลัก</div>
  <nav class="sidebar-nav-qa">
    <a class="nav-item-qa" href="dashboard.html">
      <svg class="nav-icon-qa" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/></svg>
      แดชบอร์ด
    </a>
    <a class="nav-item-qa" href="study-plan.html">
      <svg class="nav-icon-qa" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg>
      แผนการศึกษา
    </a>
    <a class="nav-item-qa active" href="course-list.html">
      <svg class="nav-icon-qa" viewBox="0 0 20 20" fill="currentColor"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/></svg>
      หลักสูตร
    </a>
    <a class="nav-item-qa" href="qa-dashboard.html">
      <svg class="nav-icon-qa" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
      ประกันคุณภาพการศึกษา
    </a>
  </nav>
  <div class="sidebar-footer-qa">
    <a class="nav-item-qa" href="login.html" id="logoutBtn">
      <svg class="nav-icon-qa" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/></svg>
      ออกจากระบบ
    </a>
  </div>
</aside>

  

<!-- ── MAIN ── -->
<div class="main">
  <div class="page-header">
    <small>แดชบอร์ด / เพิ่มหรือแก้ไขหลักสูตร</small>
    <h2 id="pageTitle">เพิ่มหลักสูตรใหม่</h2>
    <p id="pageSub">กรอกข้อมูลหลักสูตรให้ครบถ้วน แล้วกดบันทึก</p>
  </div>

  <form id="courseForm">
    <div class="card">
      <div class="card-title">ข้อมูลหลักสูตร</div>
      <div class="form-grid-2">
        <div class="field">
          <label>ชื่อหลักสูตร (ภาษาไทย) *</label>
          <input type="text" id="name_th" required />
        </div>
        <div class="field">
          <label>ชื่อหลักสูตร (ภาษาอังกฤษ)</label>
          <input type="text" id="name_en" />
        </div>
        <div class="field">
          <label>ระดับการศึกษา</label>
          <input type="text" id="degree_level" placeholder="เช่น ปริญญาตรี" />
        </div>
        <div class="field">
          <label>สถานะหลักสูตร</label>
          <select id="status">
            <option value="active">Active</option>
            <option value="draft">Draft</option>
            <option value="maintenance">Maintenance</option>
          </select>
        </div>
        <div class="field">
          <label>รูปแบบหลักสูตร</label>
          <input type="text" id="program_type" placeholder="เช่น หลักสูตร 4 ปี" />
        </div>
        <div class="field">
          <label>รูปแบบการจัดการศึกษา</label>
          <input type="text" id="study_system" placeholder="เช่น ภาคปกติ" />
        </div>
        <div class="field">
          <label>การให้ปริญญา</label>
          <input type="text" id="award_title" placeholder="เช่น บริหารธุรกิจบัณฑิต (บธ.บ.)" />
        </div>
        <div class="field">
          <label>จำนวนหน่วยกิตตลอดหลักสูตร</label>
          <input type="number" id="total_credits" placeholder="เช่น 129" />
        </div>
        <div class="field">
          <label>สำหรับนักศึกษา (รหัส)</label>
          <input type="text" id="student_range" placeholder="เช่น รหัส 67-70" />
        </div>
      </div>

      <div class="field">
        <label>คำอธิบายสั้น ๆ ของหลักสูตร</label>
        <textarea id="short_detail" placeholder="เช่น จุดเด่นของหลักสูตร กลุ่มเป้าหมาย ฯลฯ"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="card-title">รูปหลักสูตร</div>
      <div class="field">
        <label>รูปหน้าปก (Hero Image)</label>
        <input type="file" id="heroFile" accept="image/*" />
        <input type="hidden" id="hero_image" />
        <img id="heroPreview" style="max-width:200px; display:none; margin-top:10px; border-radius:8px;" />
      </div>
      <div class="field">
        <label>รูปข้อมูลหลักสูตร</label>
        <input type="file" id="infoFile" accept="image/*" />
        <input type="hidden" id="info_image" />
        <img id="infoPreview" style="max-width:200px; display:none; margin-top:10px; border-radius:8px;" />
      </div>
    </div>

    <div class="footer-actions">
      <button type="button" class="btn btn-secondary" onclick="history.back()">ยกเลิก</button>
      <button type="submit" class="btn btn-primary" id="saveBtn">บันทึกหลักสูตร</button>
      <button type="button" class="btn btn-success" id="addMajorBtn">บันทึกและเพิ่มสาขา</button>
      <button type="button" class="btn btn-secondary" id="deleteBtn" style="display:none; background:#ffdddd; color:#b33939;">ลบหลักสูตร</button>
    </div>
    <div id="message"></div>
  </form>
</div>

<script>
const BASE_URL = "https://websitefms.onrender.com";
const API = BASE_URL + "/api";

const user = localStorage.getItem("user");
if (!user) { alert("กรุณาเข้าสู่ระบบก่อน"); window.location.href = "login.html"; }

document.getElementById("logoutBtn").addEventListener("click", (e) => {
  e.preventDefault();
  localStorage.removeItem("user");
  window.location.href = "login.html";
});

const params = new URLSearchParams(window.location.search);
const courseId = params.get("courseId");
const isEdit = !!courseId;
const msg = document.getElementById("message");
const form = document.getElementById("courseForm");
const saveBtn = document.getElementById("saveBtn");
const saveAndAddBtn = document.getElementById("addMajorBtn");
const heroFile = document.getElementById("heroFile");
const heroHidden = document.getElementById("hero_image");
const heroPreview = document.getElementById("heroPreview");
const infoFile = document.getElementById("infoFile");
const infoHidden = document.getElementById("info_image");
const infoPreview = document.getElementById("infoPreview");

async function uploadImage(fileInput, hiddenInput, previewImg) {
  const file = fileInput.files[0];
  if (!file) return;
  const fd = new FormData();
  fd.append("image", file);
  msg.style.color = "#555";
  msg.textContent = "กำลังอัปโหลดรูป...";
  try {
    const res = await fetch(`${API}/upload`, { method: "POST", body: fd });
    const data = await res.json();
    if (!res.ok) { msg.style.color = "red"; msg.textContent = data.message || "อัปโหลดไม่สำเร็จ"; return; }
    hiddenInput.value = data.url;
    previewImg.src = BASE_URL + data.url;
    previewImg.style.display = "block";
    msg.style.color = "green";
    msg.textContent = "อัปโหลดสำเร็จ";
  } catch { msg.style.color = "red"; msg.textContent = "Server error (upload)"; }
}

heroFile?.addEventListener("change", () => uploadImage(heroFile, heroHidden, heroPreview));
infoFile?.addEventListener("change", () => uploadImage(infoFile, infoHidden, infoPreview));

if (isEdit) {
  saveBtn.textContent = "อัปเดตหลักสูตร";
  loadCourse();
}

async function loadCourse() {
  try {
    const res = await fetch(`${API}/courses/${courseId}`);
    const c = await res.json();
    document.getElementById("name_th").value = c.name_th || "";
    document.getElementById("name_en").value = c.name_en || "";
    document.getElementById("degree_level").value = c.degree_level || "";
    document.getElementById("status").value = c.status || "draft";
    document.getElementById("program_type").value = c.program_type || "";
    document.getElementById("study_system").value = c.study_system || "";
    document.getElementById("award_title").value = c.award_title || "";
    document.getElementById("total_credits").value = c.total_credits || "";
    document.getElementById("short_detail").value = c.short_detail || "";
    document.getElementById("student_range").value = c.student_range || "";
    if (c.hero_image) { heroHidden.value = c.hero_image; heroPreview.src = BASE_URL + c.hero_image; heroPreview.style.display = "block"; }
    if (c.info_image) { infoHidden.value = c.info_image; infoPreview.src = BASE_URL + c.info_image; infoPreview.style.display = "block"; }
  } catch { msg.textContent = "โหลดข้อมูลไม่สำเร็จ"; }
}

let afterSave = "info";
saveBtn.onclick = () => { afterSave = "info"; };
saveAndAddBtn?.addEventListener("click", () => { afterSave = "major"; form.requestSubmit(); });

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const body = {
    name_th: document.getElementById("name_th").value,
    name_en: document.getElementById("name_en").value,
    degree_level: document.getElementById("degree_level").value,
    status: document.getElementById("status").value,
    program_type: document.getElementById("program_type").value,
    study_system: document.getElementById("study_system").value,
    award_title: document.getElementById("award_title").value,
    total_credits: document.getElementById("total_credits").value,
    short_detail: document.getElementById("short_detail").value,
    student_range: document.getElementById("student_range").value,
    hero_image: heroHidden.value || null,
  info_image: infoHidden.value || null
  };
  const url = isEdit ? `${API}/courses/${courseId}` : `${API}/courses`;
  const method = isEdit ? "PUT" : "POST";
  try {
    const res = await fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) { msg.style.color = "red"; msg.textContent = data.message || "บันทึกไม่สำเร็จ"; return; }
    msg.style.color = "green";
    msg.textContent = "บันทึกสำเร็จ";
    const id = isEdit ? courseId : (data.id || data.courseId);
    setTimeout(() => {
      if (!isEdit && afterSave === "major") window.location.href = `add-major.html?courseId=${id}`;
      else window.location.href = `course-info.html?courseId=${id}`;
    }, 600);
  } catch { msg.textContent = "Server error"; }
});
</script>
</body>
</html>