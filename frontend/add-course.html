<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Add / Edit Course | FMS Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
    body {
      margin: 0;
      background: #f8f8fb;
      font-family: "Segoe UI", sans-serif;
      display: flex;
    }
    .sidebar {
      width: 240px;
      background: white;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
      padding: 20px;
      position: fixed;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 30px;
      color: #5c2ea6;
    }
    .menu {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
    }
    .menu-item {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      color: #5e5e70;
      transition: 0.2s;
    }
    .menu-item.active,
    .menu-item:hover {
      background: #f1e6ff;
      color: #5c2ea6;
    }
    .main {
      margin-left: 260px;
      padding: 25px;
      width: calc(100% - 260px);
    }
    .page-header small {
      color: #999;
      font-size: 13px;
    }
    .page-header h2 {
      margin: 4px 0;
    }
    .page-header p {
      font-size: 13px;
      color: #888;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px 22px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .form-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px 24px;
      margin-top: 12px;
      margin-bottom: 16px;
    }
    .field {
      margin-bottom: 12px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
    }
    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #faf7ff;
      outline: none;
      font-size: 14px;
    }
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      border-color: #8a3dd1;
      background: #fff;
      box-shadow: 0 0 0 2px rgba(138, 61, 209, 0.15);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .footer-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: 8px 20px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-secondary {
      background: #ffdddd;
      color: #b33939;
    }
    .btn-primary {
      background: #8a3dd1;
      color: white;
      box-shadow: 0 5px 14px rgba(138, 61, 209, 0.3);
    }
    .btn-success {
      background: #2ecc71;
      color: #fff;
      box-shadow: 0 5px 14px rgba(46, 204, 113, 0.3);
    }
    #message {
      margin-top: 8px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>FMS PSU</h2>
    <div class="menu">
      <div class="menu-item active" id="menuDashboard">แดชบอร์ด</div>
      <div class="menu-item" id="menuGeneral">ข้อมูลทั่วไป</div>
      <div class="menu-item" id="menuStudent">นักศึกษา</div>
      <div class="menu-item" id="menuPlan">แผนการศึกษา</div>
      <div class="menu-item" id="menuCourse">หลักสูตร</div>
      <div class="menu-item" id="menuQA">ประกันคุณภาพการศึกษา</div>
      <div class="menu-item" id="logoutBtn">ออกจากระบบ</div>
    </div>
  </div>


<!-- Main -->
  <div class="main">
    <div class="page-header">
      <small>แดชบอร์ด / เพิ่มหรือแก้ไขหลักสูตร</small>
      <h2 id="pageTitle">เพิ่มหลักสูตรใหม่</h2>
      <p id="pageSub">กรอกข้อมูลหลักสูตรให้ครบถ้วน แล้วกดบันทึก</p>
    </div>

    <form id="courseForm">
      <div class="card">
        <div class="card-title">ข้อมูลหลักสูตร</div>

        <div class="form-grid-2">
          <div class="field">
            <label>ชื่อหลักสูตร (ภาษาไทย) *</label>
            <input type="text" id="name_th" required />
          </div>
          <div class="field">
            <label>ชื่อหลักสูตร (ภาษาอังกฤษ)</label>
            <input type="text" id="name_en" />
          </div>

          <div class="field">
            <label>ระดับการศึกษา</label>
            <input type="text" id="degree_level" placeholder="เช่น ปริญญาตรี" />
          </div>
          <div class="field">
            <label>สถานะหลักสูตร</label>
            <select id="status">
              <option value="active">Active</option>
              <option value="draft">Draft</option>
              <option value="maintenance">Maintenance</option>
            </select>
          </div>

          <div class="field">
            <label>รูปแบบหลักสูตร</label>
            <input type="text" id="program_type" placeholder="เช่น หลักสูตร 4 ปี" />
          </div>
          <div class="field">
            <label>รูปแบบการจัดการศึกษา</label>
            <input type="text" id="study_system" placeholder="เช่น ภาคปกติ" />
          </div>

          <div class="field">
            <label>การให้ปริญญา</label>
            <input type="text" id="award_title" placeholder="เช่น บริหารธุรกิจบัณฑิต (บธ.บ.)" />
          </div>
          <div class="field">
            <label>จำนวนหน่วยกิตตลอดหลักสูตร</label>
            <input type="number" id="total_credits" placeholder="เช่น 129" />
          </div>
        </div>

        <div class="field">
          <label>คำอธิบายสั้น ๆ ของหลักสูตร</label>
          <textarea id="short_detail" placeholder="เช่น จุดเด่นของหลักสูตร กลุ่มเป้าหมาย ฯลฯ"></textarea>
        </div>


<div class="footer-actions">
  <button type="button" class="btn btn-secondary" onclick="history.back()">ยกเลิก</button>

  <button type="submit" class="btn btn-primary" id="saveBtn">
    บันทึกหลักสูตร
  </button>

  <button type="button" class="btn btn-success" id="addMajorBtn">
    บันทึกและเพิ่มสาขา
  </button>

  <button type="button" class="btn btn-danger" id="deleteBtn" style="display:none;">
    ลบหลักสูตร
  </button>
</div>

<div id="message"></div>

</div>
</form>

</div>

<script>
/* ===============================
CONFIG
=============================== */
const BASE_URL = "https://websitefms.onrender.com";
const API = BASE_URL + "/api";

/* ===============================
AUTH
=============================== */
const user = localStorage.getItem("user");
if (!user) {
  alert("กรุณาเข้าสู่ระบบก่อน");
  window.location.href = "login.html";
}

document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("user");
  window.location.href = "login.html";
};

/* ===============================
MODE
=============================== */
const params = new URLSearchParams(window.location.search);
const courseId = params.get("courseId");
const isEdit = !!courseId;

const msg = document.getElementById("message");
const form = document.getElementById("courseForm");
const saveBtn = document.getElementById("saveBtn");
const saveAndAddBtn = document.getElementById("saveAndAddMajorBtn");

/* ===============================
IMAGE ELEMENTS
=============================== */
const heroFile = document.getElementById("heroFile");
const heroHidden = document.getElementById("hero_image");
const heroPreview = document.getElementById("heroPreview");

const infoFile = document.getElementById("infoFile");
const infoHidden = document.getElementById("info_image");
const infoPreview = document.getElementById("infoPreview");

/* ===============================
UPLOAD IMAGE
=============================== */
async function uploadImage(fileInput, hiddenInput, previewImg) {
  const file = fileInput.files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append("image", file);

  msg.style.color = "#555";
  msg.textContent = "กำลังอัปโหลดรูป...";

  try {
    const res = await fetch(`${API}/upload`, {
      method: "POST",
      body: fd
    });

    const data = await res.json();

    if (!res.ok) {
      msg.style.color = "red";
      msg.textContent = data.message || "อัปโหลดไม่สำเร็จ";
      return;
    }

    hiddenInput.value = data.url;
    previewImg.src = BASE_URL + data.url;
    previewImg.style.display = "block";

    msg.style.color = "green";
    msg.textContent = "อัปโหลดสำเร็จ";

  } catch (err) {
    msg.style.color = "red";
    msg.textContent = "Server error (upload)";
  }
}

heroFile?.addEventListener("change", () =>
  uploadImage(heroFile, heroHidden, heroPreview)
);

infoFile?.addEventListener("change", () =>
  uploadImage(infoFile, infoHidden, infoPreview)
);

/* ===============================
LOAD COURSE (EDIT)
=============================== */
if (isEdit) {
  saveBtn.textContent = "อัปเดตหลักสูตร";

  loadCourse();
}

async function loadCourse() {
  try {
    const res = await fetch(`${API}/courses/${courseId}`);
    const c = await res.json();

    document.getElementById("name_th").value = c.name_th || "";
    document.getElementById("name_en").value = c.name_en || "";
    document.getElementById("degree_level").value = c.degree_level || "";
    document.getElementById("status").value = c.status || "draft";
    document.getElementById("program_type").value = c.program_type || "";
    document.getElementById("study_system").value = c.study_system || "";
    document.getElementById("award_title").value = c.award_title || "";
    document.getElementById("total_credits").value = c.total_credits || "";
    document.getElementById("short_detail").value = c.short_detail || "";

    if (c.hero_image) {
      heroHidden.value = c.hero_image;
      heroPreview.src = BASE_URL + c.hero_image;
      heroPreview.style.display = "block";
    }

    if (c.info_image) {
      infoHidden.value = c.info_image;
      infoPreview.src = BASE_URL + c.info_image;
      infoPreview.style.display = "block";
    }

  } catch (err) {
    msg.textContent = "โหลดข้อมูลไม่สำเร็จ";
  }
}

/* ===============================
SAVE MODE CONTROL
=============================== */
let afterSave = "info";

saveBtn.onclick = () => afterSave = "info";

saveAndAddBtn?.addEventListener("click", () => {
  afterSave = "major";
  form.requestSubmit();
});

/* ===============================
SUBMIT
=============================== */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const body = {
    name_th: document.getElementById("name_th").value,
    name_en: document.getElementById("name_en").value,
    degree_level: document.getElementById("degree_level").value,
    status: document.getElementById("status").value,
    program_type: document.getElementById("program_type").value,
    study_system: document.getElementById("study_system").value,
    award_title: document.getElementById("award_title").value,
    total_credits: document.getElementById("total_credits").value,
    short_detail: document.getElementById("short_detail").value,
    hero_image: heroHidden.value,
    info_image: infoHidden.value
  };

  const url = isEdit
    ? `${API}/courses/${courseId}`
    : `${API}/courses`;

  const method = isEdit ? "PUT" : "POST";

  try {
    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (!res.ok) {
      msg.style.color = "red";
      msg.textContent = data.message || "บันทึกไม่สำเร็จ";
      return;
    }

    msg.style.color = "green";
    msg.textContent = "บันทึกสำเร็จ";

    const id = isEdit ? courseId : data.courseId;

    setTimeout(() => {
      if (!isEdit && afterSave === "major") {
        window.location.href = `add-major.html?courseId=${id}`;
      } else {
        window.location.href = `course-info.html?courseId=${id}`;
      }
    }, 600);

  } catch (err) {
    msg.textContent = "Server error";
  }
});
</script>

</body>
</html>
