<script>
// =============================
// CONFIG
// =============================
const BASE_URL = "https://websitefms.onrender.com";

// =============================
// ELEMENTS
// =============================
const courseForm = document.getElementById("courseForm");
const courseIdInput = document.getElementById("courseId");

// File inputs
const heroFile = document.getElementById("heroFile");
const infoFile = document.getElementById("infoFile");
const homeFile = document.getElementById("homeFile");

// Hidden inputs
const heroHidden = document.getElementById("hero_image");
const infoHidden = document.getElementById("info_image");
const homeHidden = document.getElementById("home_image");

// Preview images
const heroPreview = document.getElementById("heroPreview");
const infoPreview = document.getElementById("infoPreview");
const homePreview = document.getElementById("homePreview");

// =============================
// UPLOAD IMAGE FUNCTION
// =============================
async function uploadImage(fileInput, hiddenInput, previewImg) {
  const file = fileInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("image", file);

  try {
    const res = await fetch(`${BASE_URL}/api/upload`, {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (res.ok) {
      hiddenInput.value = data.url;
      previewImg.src = BASE_URL + data.url;
      previewImg.style.display = "block";
      console.log("Upload success:", data.url);
    } else {
      alert("Upload failed: " + data.error);
    }
  } catch (err) {
    console.error(err);
    alert("Upload error");
  }
}

// Event listeners
heroFile.addEventListener("change", () =>
  uploadImage(heroFile, heroHidden, heroPreview)
);

infoFile.addEventListener("change", () =>
  uploadImage(infoFile, infoHidden, infoPreview)
);

homeFile.addEventListener("change", () =>
  uploadImage(homeFile, homeHidden, homePreview)
);

// =============================
// LOAD COURSE FOR EDIT
// =============================
async function loadCourseForEdit(id) {
  try {
    const res = await fetch(`${BASE_URL}/api/courses/${id}`);
    const data = await res.json();

    // Fill form
    document.getElementById("course_name").value = data.course_name;
    document.getElementById("course_description").value = data.course_description;
    document.getElementById("course_details").value = data.course_details;

    heroHidden.value = data.hero_image || "";
    infoHidden.value = data.info_image || "";
    homeHidden.value = data.home_image || "";

    if (data.hero_image) {
      heroPreview.src = BASE_URL + data.hero_image;
      heroPreview.style.display = "block";
    }

    if (data.info_image) {
      infoPreview.src = BASE_URL + data.info_image;
      infoPreview.style.display = "block";
    }

    if (data.home_image) {
      homePreview.src = BASE_URL + data.home_image;
      homePreview.style.display = "block";
    }

    courseIdInput.value = id;

  } catch (err) {
    console.error("Load error:", err);
    alert("โหลดข้อมูลไม่สำเร็จ");
  }
}

// =============================
// SAVE / UPDATE COURSE
// =============================
courseForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const id = courseIdInput.value;

  const payload = {
    course_name: document.getElementById("course_name").value,
    course_description: document.getElementById("course_description").value,
    course_details: document.getElementById("course_details").value,
    hero_image: heroHidden.value,
    info_image: infoHidden.value,
    home_image: homeHidden.value
  };

  try {
    const res = await fetch(
      id ? `${BASE_URL}/api/courses/${id}` : `${BASE_URL}/api/courses`,
      {
        method: id ? "PUT" : "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );

    const data = await res.json();

    if (res.ok) {
      alert(id ? "อัปเดตสำเร็จ" : "เพิ่มคอร์สสำเร็จ");
      window.location.href = "courses.html";
    } else {
      alert(data.error || "เกิดข้อผิดพลาด");
    }

  } catch (err) {
    console.error(err);
    alert("Server error");
  }
});

// =============================
// CHECK URL PARAM (EDIT MODE)
// =============================
const params = new URLSearchParams(window.location.search);
const editId = params.get("id");

if (editId) {
  loadCourseForEdit(editId);
}
</script>
