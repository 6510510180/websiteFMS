<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Add / Edit Course | FMS Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body{
  margin:0;
  background:#f8f8fb;
  font-family:"Segoe UI",sans-serif;
  display:flex;
}
.sidebar{
  width:240px;
  background:white;
  height:100vh;
  box-shadow:2px 0 10px rgba(0,0,0,0.05);
  padding:20px;
  position:fixed;
}
.sidebar h2{
  color:#5c2ea6;
}
.menu-item{
  padding:12px;
  border-radius:10px;
  margin-bottom:8px;
  cursor:pointer;
}
.menu-item:hover{
  background:#f1e6ff;
  color:#5c2ea6;
}
.main{
  margin-left:260px;
  padding:25px;
  width:calc(100% - 260px);
}
.card{
  background:white;
  border-radius:16px;
  padding:20px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
.field input,
.field textarea,
.field select{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  background:#faf7ff;
}
.footer-actions{
  margin-top:20px;
  display:flex;
  gap:10px;
  justify-content:flex-end;
}
.btn{
  border:none;
  padding:10px 18px;
  border-radius:20px;
  cursor:pointer;
}
.btn-primary{background:#8a3dd1;color:#fff;}
.btn-success{background:#2ecc71;color:#fff;}
.btn-danger{background:#ff4d4d;color:#fff;}
.btn-secondary{background:#eee;}
#message{margin-top:10px;font-size:13px;}
</style>
</head>

<body>

<!-- Sidebar -->
<div class="sidebar">
  <h2>FMS PSU</h2>
  <div class="menu-item" onclick="location.href='dashboard.html'">แดชบอร์ด</div>
  <div class="menu-item">จัดการหลักสูตร</div>
  <div class="menu-item" id="logoutBtn">ออกจากระบบ</div>
</div>

<!-- Main -->
<div class="main">

<h2 id="pageTitle">เพิ่มหลักสูตร</h2>

<form id="courseForm">
<div class="card">

<div class="form-grid">
  <div class="field">
    <label>ชื่อหลักสูตร (ไทย)*</label>
    <input id="name_th" required>
  </div>

  <div class="field">
    <label>ชื่อหลักสูตร (อังกฤษ)</label>
    <input id="name_en">
  </div>

  <div class="field">
    <label>ระดับการศึกษา</label>
    <input id="degree_level">
  </div>

  <div class="field">
    <label>สถานะ</label>
    <select id="status">
      <option value="active">Active</option>
      <option value="draft">Draft</option>
    </select>
  </div>

  <div class="field">
    <label>จำนวนหน่วยกิต</label>
    <input type="number" id="total_credits">
  </div>
</div>

<div class="field">
  <label>คำอธิบาย</label>
  <textarea id="short_detail"></textarea>
</div>

<div class="footer-actions">
  <button type="button" class="btn btn-secondary" onclick="history.back()">ยกเลิก</button>

  <button type="submit" class="btn btn-primary" id="saveBtn">
    บันทึกหลักสูตร
  </button>

  <button type="button" class="btn btn-success" id="addMajorBtn">
    บันทึกและเพิ่มสาขา
  </button>

  <button type="button" class="btn btn-danger" id="deleteBtn" style="display:none;">
    ลบหลักสูตร
  </button>
</div>

<div id="message"></div>

</div>
</form>

</div>

<script>
/* ===============================
CONFIG
=============================== */
const BASE_URL = "https://websitefms.onrender.com";
const API = BASE_URL + "/api";

/* ===============================
AUTH CHECK
=============================== */
const token = localStorage.getItem("user");
if(!token){
  alert("กรุณาเข้าสู่ระบบก่อน");
  window.location.href = "login.html";
}

document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.removeItem("user");
  window.location.href = "login.html";
};

/* ===============================
MODE
=============================== */
const params = new URLSearchParams(window.location.search);
const courseId = params.get("courseId");
const isEdit = !!courseId;

const pageTitle = document.getElementById("pageTitle");
const saveBtn = document.getElementById("saveBtn");
const deleteBtn = document.getElementById("deleteBtn");
const addMajorBtn = document.getElementById("addMajorBtn");
const msg = document.getElementById("message");

if(isEdit){
  pageTitle.textContent = "แก้ไขหลักสูตร";
  saveBtn.textContent = "อัปเดตหลักสูตร";
  deleteBtn.style.display = "inline-block";
  loadCourse();
}

/* ===============================
LOAD COURSE
=============================== */
async function loadCourse(){
  try{
    const res = await fetch(`${API}/courses/${courseId}`,{
      headers:{ Authorization:`Bearer ${token}` }
    });
    const c = await res.json();

    document.getElementById("name_th").value = c.name_th || "";
    document.getElementById("name_en").value = c.name_en || "";
    document.getElementById("degree_level").value = c.degree_level || "";
    document.getElementById("status").value = c.status || "draft";
    document.getElementById("total_credits").value = c.total_credits || "";
    document.getElementById("short_detail").value = c.short_detail || "";

  }catch(err){
    msg.textContent = "โหลดข้อมูลไม่สำเร็จ";
  }
}

/* ===============================
SAVE / UPDATE
=============================== */
document.getElementById("courseForm").addEventListener("submit", async(e)=>{
  e.preventDefault();

  const body = {
    name_th: name_th.value,
    name_en: name_en.value,
    degree_level: degree_level.value,
    status: status.value,
    total_credits: total_credits.value,
    short_detail: short_detail.value
  };

  const url = isEdit ? `${API}/courses/${courseId}` : `${API}/courses`;
  const method = isEdit ? "PUT" : "POST";

  try{
    const res = await fetch(url,{
      method,
      headers:{
        "Content-Type":"application/json",
        Authorization:`Bearer ${token}`
      },
      body:JSON.stringify(body)
    });

    const data = await res.json();

    if(!res.ok){
      msg.style.color="red";
      msg.textContent=data.message || "บันทึกไม่สำเร็จ";
      return;
    }

    msg.style.color="green";
    msg.textContent="บันทึกสำเร็จ";

    const id = isEdit ? courseId : data.courseId;

    setTimeout(()=>{
      window.location.href=`course-info.html?courseId=${id}`;
    },500);

  }catch(err){
    msg.textContent="เชื่อมต่อเซิร์ฟเวอร์ไม่ได้";
  }
});

/* ===============================
DELETE
=============================== */
deleteBtn.onclick = async ()=>{
  if(!confirm("ต้องการลบหลักสูตรนี้?")) return;

  const res = await fetch(`${API}/courses/${courseId}`,{
    method:"DELETE",
    headers:{ Authorization:`Bearer ${token}` }
  });

  if(res.ok){
    alert("ลบสำเร็จ");
    window.location.href="courses.html";
  }else{
    alert("ลบไม่สำเร็จ");
  }
};

/* ===============================
SAVE + ADD MAJOR
=============================== */
addMajorBtn.onclick = ()=>{
  if(!isEdit){
    alert("กรุณาบันทึกหลักสูตรก่อน");
    return;
  }
  window.location.href=`add-major.html?courseId=${courseId}`;
};
</script>

</body>
</html>
